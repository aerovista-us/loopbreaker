<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loop Breaker — In‑Moment + Journal Workbook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg0:#05070a; --bg1:#0a0f16;
      --card:#101722; --card2:#141d2a; --card3:#0d121b;
      --accent:#7fffd4; --accent2:#ffb86c; --danger:#ff6b81; --ink:#f5f7fb; --muted:#9aa3ba;
      --line:#232c3a; --pill:#1a2433;
      --shadow:0 18px 40px rgba(0,0,0,.62);
      --r-lg:18px; --r-md:12px; --r-pill:999px;
      --t:.18s ease-out;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #101728 0, var(--bg0) 42%);
      min-height:100vh;
    }
    .page{max-width:1180px;margin:0 auto;padding:18px 14px 40px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;justify-content:space-between;margin-bottom:14px}
    h1{margin:0;font-size:1.55rem;letter-spacing:.03em}
    .sub{margin:6px 0 0;max-width:760px;color:var(--muted);font-size:.92rem;line-height:1.35}
    .top-right{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}
    .pill{padding:6px 10px;border-radius:var(--r-pill);background:var(--pill);border:1px solid rgba(127,255,212,.14);color:var(--muted);font-size:.74rem;letter-spacing:.08em;text-transform:uppercase}
    .btn{
      border-radius:var(--r-pill); border:1px solid var(--line);
      background:var(--pill); color:var(--muted);
      padding:8px 12px; font-size:.82rem; cursor:pointer;
      transition:transform var(--t), border-color var(--t), color var(--t), background var(--t);
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(127,255,212,.65);color:var(--accent)}
    .btn.danger:hover{border-color:rgba(255,107,129,.75);color:var(--danger)}
    .btn.accent{border-color:rgba(127,255,212,.45);color:var(--accent)}
    .btn.accent:hover{background:rgba(127,255,212,.08)}
    .btn.small{padding:6px 10px;font-size:.78rem}
    .grid{display:grid;grid-template-columns:minmax(0,1.05fr) minmax(0,1fr);gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:minmax(0,1fr)}}
    .card{
      background:rgba(5,7,10,.56);
      border:1px solid var(--line);
      border-radius:var(--r-lg);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h2{margin:0 0 8px;font-size:1rem;letter-spacing:.02em}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .spacer{flex:1}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:10px 0}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{
      padding:7px 10px;border-radius:var(--r-pill);
      border:1px solid var(--line);
      background:var(--card3);
      color:var(--muted);
      font-size:.8rem;cursor:pointer;
      transition: border-color var(--t), color var(--t), transform var(--t), background var(--t);
    }
    .tab:hover{transform:translateY(-1px);border-color:rgba(127,255,212,.55);color:var(--accent)}
    .tab.active{background:linear-gradient(135deg,#1b2838,#243348);border-color:var(--accent);color:var(--accent)}
    .loop-strip{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;scrollbar-width:thin;scrollbar-color:rgba(127,255,212,.18) transparent}
    .loop-strip::-webkit-scrollbar{height:6px}
    .loop-strip::-webkit-scrollbar-thumb{background:rgba(127,255,212,.18);border-radius:999px}
    .step{
      min-width:178px;max-width:215px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:10px 10px 12px;
      cursor:pointer;
      transition: transform var(--t), border-color var(--t), box-shadow var(--t), background var(--t);
    }
    .step:hover{transform:translateY(-2px);border-color:rgba(127,255,212,.5);box-shadow:0 10px 28px rgba(0,0,0,.7)}
    .step.active{background:linear-gradient(145deg,#111a28,#182538);border-color:var(--accent);box-shadow:0 16px 34px rgba(0,0,0,.9)}
    .step-tag{font-size:.64rem;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
    .step-title{font-size:.9rem;font-weight:650;margin-bottom:6px}
    .step-sub{font-size:.76rem;color:var(--muted);line-height:1.25}
    .arrow{align-self:center;color:rgba(255,255,255,.5)}
    .two{display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);gap:10px}
    @media (max-width:820px){.two{grid-template-columns:minmax(0,1fr)}}
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:10px 12px;
    }
    .panel h3{margin:0 0 6px;font-size:.88rem}
    .panel p,.panel ul{margin:0;color:var(--muted);font-size:.83rem;line-height:1.38}
    .panel ul{padding-left:18px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{
      font-size:.72rem;border-radius:var(--r-pill);
      padding:3px 9px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--muted)
    }
    .chip.a{border-color:rgba(127,255,212,.55);color:var(--accent)}
    .chip.b{border-color:rgba(255,184,108,.6);color:var(--accent2)}
    .chip.d{border-color:rgba(255,107,129,.7);color:var(--danger)}
    textarea, input[type="text"], select{
      width:100%;
      border-radius:var(--r-md);
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--ink);
      padding:9px 10px;
      font-size:.84rem;
      outline:none;
      transition:border-color var(--t), box-shadow var(--t), background var(--t);
    }
    textarea{min-height:92px;max-height:420px;resize:vertical;line-height:1.35}
    textarea:focus,input[type="text"]:focus,select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(127,255,212,.3);
      background:#151f30;
    }
    .label{font-size:.78rem;color:var(--muted);margin-bottom:6px}
    .kpi{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px
    }
    @media (max-width:560px){.kpi{grid-template-columns:minmax(0,1fr)}}
    .k{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:10px 12px;
    }
    .k .n{font-family:var(--mono);font-size:1.05rem;color:var(--accent)}
    .k .t{font-size:.74rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-top:3px}
    .callout{
      border:1px solid rgba(127,255,212,.18);
      background:linear-gradient(145deg, rgba(127,255,212,.08), rgba(255,184,108,.05));
      border-radius:var(--r-md);
      padding:12px;
    }
    .callout strong{color:var(--accent)}
    .notice{font-size:.76rem;color:var(--muted);line-height:1.4;margin-top:8px}
    .hr{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .log{display:grid;gap:8px;max-height:420px;overflow:auto;padding-right:2px}
    .entry{border:1px solid var(--line);background:var(--card);border-radius:var(--r-md);padding:10px 12px}
    .entry .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:var(--muted);font-size:.75rem}
    .entry .meta code{font-family:var(--mono);font-size:.72rem;background:rgba(255,255,255,.04);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.06)}
    .entry .txt{margin-top:8px;color:var(--ink);font-size:.85rem;line-height:1.4;white-space:pre-wrap}
    .mini{font-size:.76rem;color:var(--muted)}
    .rightcol .card{position:sticky;top:12px}
    @media (max-width:980px){.rightcol .card{position:relative;top:auto}}
    audio{width:100%; margin-top:8px}
    .range{width:100%}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:.72rem;color:var(--muted);
      padding:4px 10px;border-radius:var(--r-pill);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(127,255,212,.35)}
    .dot.red{background:rgba(255,107,129,.5)}
    .dot.amber{background:rgba(255,184,108,.5)}
    .kbd{
      font-family:var(--mono);
      font-size:.73rem;
      padding:2px 7px;
      border-radius:9px;
      border:1px solid rgba(255,255,255,.1);
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>Loop Breaker — In‑Moment + Journal</h1>
        <p class="sub">
          Built for real-time use: validate feelings, protect truth, keep your energy, set compassionate cutoffs, and log it clean.
          <span class="muted">No reality-bending. No emotional hostage situations.</span>
          <br><span class="muted">Designed to be fair to both partners — and strong enough to keep conversations safe.</span>
        </p>
        <div class="row" style="margin-top:10px;gap:8px">
          <span class="pill">A‑stride swagger</span>
          <span class="pill">empathy + boundaries</span>
          <span class="pill">In‑moment scripts</span>
          <span class="pill">journal + playback</span>
        </div>
      </div>
      <div class="top-right">
        <span class="badge"><span class="dot"></span><span>Autosave: On</span></span>
        <button class="btn small" id="btn-export">Export JSON</button>
        <button class="btn small danger" id="btn-reset">Reset All</button>
      </div>
    </header>

    <div class="grid">
      <div class="leftcol">
        <div class="card">
          <div class="row">
            <h2 style="margin:0">Mode</h2>
            <div class="tabs" id="tabs">
              <button class="tab active" data-tab="moment">In‑Moment</button>
              <button class="tab" data-tab="journal">Journal</button>
              <button class="tab" data-tab="playbook">Playbook</button>
              <button class="tab" data-tab="exercises">Exercises</button>
            </div>
            <div class="spacer"></div>
            <div class="row" style="gap:8px">
              <span class="badge" id="session-label-wrap"><span class="dot amber"></span><span id="session-label">Session: ready</span></span>
              <span class="badge"><span class="dot red" id="cut-dot" style="display:none"></span><span id="cut-label">Cutoff: not set</span></span>
            </div>
          </div>

          <div class="divider"></div>

          <div id="tab-moment">
            <div class="row" style="gap:10px; align-items:flex-end">
              <div style="min-width:220px;flex:1">
                <div class="label">View</div>
                <select id="profile">
                  <option value="P1">Partner 1</option>
                  <option value="P2">Partner 2</option>
                  <option value="T">Together</option>
                </select>
              </div>
              <div style="min-width:220px;flex:1">
                <div class="label">Where are we in the loop?</div>
                <select id="step-select"></select>
              </div>
              <div style="min-width:220px;flex:1">
                <div class="label">Cutoff timer (compassionate exit)</div>
                <select id="cutoff">
                  <option value="0">No cutoff</option>
                  <option value="5">5 min</option>
                  <option value="10">10 min</option>
                  <option value="15">15 min</option>
                  <option value="20">20 min</option>
                  <option value="30">30 min</option>
                </select>
              </div>
              <button class="btn accent" id="btn-start">Start</button>
              <button class="btn danger" id="btn-stop">Stop</button>
            </div>

            <div class="hr"></div>

            <div class="callout">
              <div class="row">
                <h2 style="margin:0">Quick Script (scan + say it)</h2>
                <div class="spacer"></div>
                <button class="btn small" id="btn-speak">Speak</button>
                <button class="btn small" id="btn-copy">Copy</button>
              </div>
              <div class="divider"></div>
              <div id="script-text" style="white-space:pre-wrap;line-height:1.45;font-size:.9rem"></div>
              <div class="notice">
                <strong>Rule:</strong> Validate the <em>feeling</em>, but don’t validate a false story.
                If someone says “I feel…” followed by a thought/accusation, translate it back into a feeling + request.
              </div>
            </div>

            <div class="hr"></div>

            <div class="two">
              <div class="panel">
                <h3>Feel vs Think (fast translator)</h3>
                <p class="mini">Paste “I feel you don’t care” → converts to feeling + observation + request.</p>
                <div class="divider"></div>
                <div class="label">Input</div>
                <input type="text" id="fv-input" placeholder="I feel like you never listen..." />
                <div class="row" style="margin-top:8px">
                  <button class="btn small" id="btn-fv">Translate</button>
                  <button class="btn small" id="btn-fv-speak">Speak</button>
                  <div class="spacer"></div>
                  <span class="mini">Keep it short + concrete.</span>
                </div>
                <div class="divider"></div>
                <div class="label">Output</div>
                <textarea id="fv-output" placeholder="Feeling: ...  Observation: ...  Request: ..."></textarea>
              </div>

              <div class="panel">
                <h3>Reality Anchor (protect truth)</h3>
                <p class="mini">Stay fair without becoming the emotional regulator.</p>
                <div class="divider"></div>
                <ul id="anchor-list"></ul>
                <div class="chips">
                  <span class="chip a">Empathy ≠ confession</span>
                  <span class="chip b">Feelings are real</span>
                  <span class="chip d">Stories get checked</span>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="panel">
              <div class="row">
                <h3 style="margin:0">One‑tap Log (so it doesn’t spiral)</h3>
                <div class="spacer"></div>
                <span class="mini">Shortcut: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> saves.</span>
              </div>
              <div class="divider"></div>
              <div class="two">
                <div>
                  <div class="label">Facts (what actually happened)</div>
                  <textarea id="log-facts" placeholder="Facts only. Time, actions, words. No interpretation."></textarea>
                </div>
                <div>
                  <div class="label">Feeling + Need (clean + direct)</div>
                  <textarea id="log-need" placeholder="Feeling: ___  Need: ___  Request: ___"></textarea>
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn accent" id="btn-save">Save Entry</button>
                <button class="btn" id="btn-clear-fields">Clear Fields</button>
                <div class="spacer"></div>
                <span class="mini">Saved locally (per view).</span>
              </div>
            </div>
          </div>

          <div id="tab-journal" style="display:none">
            <div class="kpi">
              <div class="k"><div class="n" id="k-count">0</div><div class="t">entries saved</div></div>
              <div class="k"><div class="n" id="k-last">—</div><div class="t">last entry</div></div>
              <div class="k"><div class="n" id="k-mode">A</div><div class="t">current view</div></div>
            </div>

            <div class="hr"></div>

            <div class="row" style="gap:10px;align-items:flex-end">
              <div style="flex:1;min-width:220px">
                <div class="label">Search</div>
                <input type="text" id="search" placeholder="Type to filter entries..." />
              </div>
              <div style="min-width:200px">
                <div class="label">Filter by loop step</div>
                <select id="filter-step"><option value="all">All steps</option></select>
              </div>
              <div style="min-width:200px">
                <div class="label">Export / tools</div>
                <div class="row">
                  <button class="btn small" id="btn-export2">Export JSON</button>
                  <button class="btn small danger" id="btn-clear-log">Clear Log</button>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="log" id="log-list"></div>
          </div>

          <div id="tab-playbook" style="display:none">
            <div class="callout">
              <div class="row">
                <h2 style="margin:0">Playbook Invite</h2>
                <div class="spacer"></div>
                <button class="btn small" id="btn-invite-speak">Speak</button>
                <button class="btn small" id="btn-invite-copy">Copy</button>
              </div>
              <div class="divider"></div>
              <div class="label">Message (editable — saved locally)</div>
              <textarea id="pb-intro" style="min-height:220px"></textarea>
              <div class="row" style="margin-top:10px">
                <button class="btn small" id="btn-reset-intro">Reset</button>
                <button class="btn small danger" id="btn-clear-intro">Clear</button>
                <div class="spacer"></div>
                <span class="mini">Read when calm, not mid‑spike.</span>
              </div>
            </div>

            <div class="hr"></div>

            <div class="two">
              <div class="panel">
                <h3>Protected time (non‑negotiable with love)</h3>
                <ul>
                  <li>2–3 couple blocks/week — no work/gaming.</li>
                  <li>10‑minute daily check‑in (before bed / shared meal / call).</li>
                  <li>When conflict starts: agree on a cutoff timer and a return time.</li>
                </ul>
              </div>
              <div class="panel">
                <h3>Compassionate cutoff (exit script)</h3>
                <p class="mini">Stop spirals without punishing anyone.</p>
                <div class="divider"></div>
                <textarea id="cutoff-script" style="min-height:140px"></textarea>
                <div class="row" style="margin-top:8px">
                  <button class="btn small" id="btn-cut-speak">Speak</button>
                  <button class="btn small" id="btn-cut-copy">Copy</button>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="panel">
              <h3>Weekly check‑in notes</h3>
              <textarea id="pb-weekly" placeholder="What felt good? What hurt? One adjustment. Effort noticed from each other."></textarea>
              <div class="notice"><strong>Pattern rule:</strong> defensiveness means “slow down,” not “win.”</div>
            

          <div id="tab-exercises" style="display:none">
            <div class="callout">
              <div class="row">
                <h2 style="margin:0">Joint Practice — build new reflexes</h2>
                <div class="spacer"></div>
                <button class="btn small" id="btn-ex-speak">Speak</button>
                <button class="btn small" id="btn-ex-copy">Copy</button>
              </div>
              <div class="divider"></div>
              <div class="label">Today’s drill (2–10 minutes)</div>
              <select id="exercise-pick"></select>
              <div class="divider"></div>
              <div id="exercise-text" style="white-space:pre-wrap;line-height:1.45;font-size:.9rem"></div>
              <div class="notice">
                <strong>Goal:</strong> not “win the argument.” Build a repeatable way to feel safe, stay accurate, and stay connected.
              </div>
            </div>

            <div class="hr"></div>

            <div class="two">
              <div class="panel">
                <h3>Repair ritual (post-spike, same day)</h3>
                <ul>
                  <li><strong>Own</strong>: “Here’s what I did that had impact.”</li>
                  <li><strong>Validate</strong>: “Your feeling makes sense.”</li>
                  <li><strong>Clarify</strong>: “Here’s what I meant / what I didn’t mean.”</li>
                  <li><strong>Request</strong>: “Next time, can we do ____?”</li>
                  <li><strong>Close</strong>: one small act of care (touch, tea, walk, meme).</li>
                </ul>
              </div>
              <div class="panel">
                <h3>Conversation safety rules (for both)</h3>
                <ul>
                  <li>No insults, threats, or scorekeeping.</li>
                  <li>No mind-reading (“you meant…”). Ask first.</li>
                  <li>“I feel” must be a feeling, not an accusation.</li>
                  <li>One topic at a time. No history dump.</li>
                  <li>Cutoff is a pause, not abandonment — return time required.</li>
                </ul>
              </div>
            </div>

            <div class="hr"></div>

            <div class="panel">
              <h3>Mini journal (together)</h3>
              <div class="two">
                <div>
                  <div class="label">What went well (today)</div>
                  <textarea id="ex-good" placeholder="2–3 things that helped connection, even small."></textarea>
                </div>
                <div>
                  <div class="label">One adjustment (tomorrow)</div>
                  <textarea id="ex-adjust" placeholder="One specific change we’ll try next time."></textarea>
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn accent" id="btn-ex-save">Save Joint Notes</button>
                <button class="btn danger" id="btn-ex-clear">Clear</button>
                <div class="spacer"></div>
                <span class="mini">Saved locally.</span>
              </div>
            </div>
          </div>
</div>
          </div>

        </div>

        <div class="card" style="margin-top:12px">
          <h2>Loop Overview (tap a step)</h2>
          <div class="loop-strip" id="loop-strip"></div>
          <div class="two" style="margin-top:12px">
            <div class="panel">
              <h3 id="d-title">Step</h3>
              <p id="d-what"></p>
              <div class="chips">
                <span class="chip b" id="d-them"></span>
                <span class="chip a" id="d-you"></span>
              </div>
            </div>
            <div class="panel">
              <h3>Interrupt Moves</h3>
              <ul id="d-interrupt"></ul>
            </div>
          </div>
          <div class="notice" style="margin-top:10px">
            <strong>Riff:</strong> Emotion hits → story hunts → blame attaches → repair demanded → you regulate → peace returns → repeat.
            Upgrade: feelings first, stories checked second, reality stays intact, energy stays protected.
          </div>
        </div>
      </div>

      <div class="rightcol">
        <div class="card">
          <div class="row">
            <h2 style="margin:0">Media + Voice</h2>
            <div class="spacer"></div>
            <button class="btn small" id="btn-tts-stop">Stop Voice</button>
          </div>
          <div class="divider"></div>

          <div class="panel" style="margin-bottom:10px">
            <h3 style="margin:0 0 6px">Ambient Player (local storage playlist)</h3>
            <p class="mini">Add tracks now by URL. Later we can wire local files + your Swamp‑Hop noir loop.</p>
            <div class="divider"></div>
            <div class="row">
              <button class="btn small" id="btn-add-track">Add Track</button>
              <button class="btn small danger" id="btn-clear-tracks">Clear</button>
              <div class="spacer"></div>
              <span class="mini">Saved locally.</span>
            </div>
            <audio id="audio" controls preload="none"></audio>
            <div class="row" style="margin-top:8px;gap:10px">
              <div style="flex:1">
                <div class="label">Playback rate</div>
                <input class="range" type="range" min="0.75" max="1.25" step="0.05" value="1" id="rate" />
              </div>
              <div style="min-width:160px">
                <div class="label">Loop</div>
                <select id="loopmode">
                  <option value="track">Track</option>
                  <option value="playlist">Playlist</option>
                  <option value="off">Off</option>
                </select>
              </div>
            </div>
            <div class="divider"></div>
            <div class="label">Playlist</div>
            <div id="playlist" class="log" style="max-height:210px"></div>
          </div>

          <div class="panel">
            <h3 style="margin:0 0 6px">ByteCast Voice (built‑in TTS)</h3>
            <p class="mini">Uses your browser’s speech engine. Great for “read the script while you breathe.”</p>
            <div class="divider"></div>
            <div class="row">
              <div style="flex:1;min-width:180px">
                <div class="label">Voice</div>
                <select id="voice"></select>
              </div>
              <div style="flex:1;min-width:180px">
                <div class="label">Style</div>
                <select id="tts-style">
                  <option value="calm">Calm</option>
                  <option value="coach">Coach</option>
                  <option value="neutral">Neutral</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn small accent" id="btn-tts-speak">Speak Text Below</button>
              <button class="btn small" id="btn-tts-paste-script">Paste Current Script</button>
            </div>
            <div class="divider"></div>
            <textarea id="tts-text" placeholder="Paste anything here… playbook invite, cutoff script, your notes, etc."></textarea>
            <div class="notice">
              <strong>In‑moment pro move:</strong> Anchor reality → name the pattern → offer one next step → exit on cutoff.
            </div>
          </div>

          <div class="notice" style="margin-top:10px">
            Everything persists in localStorage. Export JSON to move between devices. (Both partners can use one file on the same device.)
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const LOOP = [
  { id: 1, tag: "Body", title: "Emotion Spike", short:"A strong feeling shows up before the story is clear.",
    what:"A nervous-system spike can arrive fast (anxiety, shame, anger, fear, loneliness). A spike is real — and it is not automatic proof of who caused it.",
    p1:"Feels impact, wants clarity, may push for reassurance.",
    p2:"Feels pressure, may feel blamed, may switch into defense/fixer mode.",
    interrupt:[
      "Slow the tempo (both).",
      "Name the feeling first; story second.",
      "Decide: care stays on; reality stays intact."
    ]},
  { id: 2, tag:"Search", title:"Meaning-Making", short:"The mind hunts for a reason to explain the feeling.",
    what:"When emotion is uncomfortable, the brain scans for a cause (tone, timing, details). This can produce assumptions faster than facts.",
    p1:"Tempted to interpret or mind-read.",
    p2:"Tempted to over-explain or shut down.",
    interrupt:[
      "Ask for one specific moment.",
      "Use facts: what happened / what was said.",
      "Label guesses as guesses."
    ]},
  { id: 3, tag:"Attach", title:"Pin It on the Other", short:"The feeling gets linked to the partner as the cause.",
    what:"A spike can turn into certainty: 'I feel this because you did X.' Sometimes true; sometimes a shortcut that skips verification.",
    p1:"May escalate certainty, demand repair.",
    p2:"May feel accused, counter-argue, or cave to restore peace.",
    interrupt:[
      "Separate feeling from conclusion.",
      "Ban global frames (always/never).",
      "Care without forced confession."
    ]},
  { id: 4, tag:"Drift", title:"Narrative Drift", short:"Details start shifting to match the emotion’s conclusion.",
    what:"When the goal becomes emotional coherence, accuracy can slip. This is where looping happens and trust erodes.",
    p1:"May double down, stack examples, intensify language.",
    p2:"May feel miscast, get sharper, or try to 'fix' perception.",
    interrupt:[
      "Re-anchor: timestamps, exact words, single claim.",
      "Pause if insults/mind-reading begins.",
      "Return to one request."
    ]},
  { id: 5, tag:"Repair", title:"Repair Demand", short:"Reassurance or apology is demanded right now, on one person’s terms.",
    what:"Repair is healthy; pressure-based repair is not. The difference: shared goals vs forcing someone to carry the whole emotional load.",
    p1:"Wants proof of care, safety, commitment.",
    p2:"Wants fairness, accuracy, and room to be human.",
    interrupt:[
      "Offer support + next step without rewriting truth.",
      "Make requests specific (one action, one time).",
      "If it becomes coercive, use the cutoff."
    ]},
  { id: 6, tag:"Regulate", title:"Over-Functioning", short:"One partner becomes the regulator to restore calm.",
    what:"If calm returns only when one person fixes, apologizes, or performs care, the loop gets reinforced.",
    p1:"Gets soothed temporarily, but no new skill is built.",
    p2:"Gets drained, resentful, and vigilant.",
    interrupt:[
      "Scale effort to responsibility.",
      "Switch to joint tools (translator, repair ritual).",
      "Name the pattern without blame."
    ]},
  { id: 7, tag:"Reset", title:"Temporary Peace", short:"Harmony returns — then the next spike restarts the cycle.",
    what:"Without practice + agreements, the nervous system learns 'spike → pressure → soothing' and repeats it.",
    p1:"Feels relief, but fears it will happen again.",
    p2:"Feels relief, but fears it will happen again.",
    interrupt:[
      "Do a 5-minute drill when calm.",
      "Schedule protected time (connection builds safety).",
      "Commit to cutoff + return time every time."
    ]}
];

const ANCHORS = [
  "I believe your feeling is real.",
  "I’m not agreeing with every conclusion yet — I’m checking what happened.",
  "Let’s name the feeling, then confirm one fact.",
  "One topic at a time. No always/never.",
  "Empathy isn’t a confession. Accuracy isn’t cruelty.",
  "If we hit insults, threats, or coercion, we pause and return later."
];

function buildScript(view, stepId, cutoffMin, running){
  const s = LOOP.find(x=>x.id===stepId) || LOOP[0];
  const cutoffLine = cutoffMin>0
    ? `\n\nCutoff: We’ve got ${cutoffMin} minutes to stay constructive. If we start looping or getting sharp, we pause and set a return time.`
    : "";
  const P1 = [
`I’m hearing a real feeling. I want to stay connected AND stay accurate.

Can we do this clean?
• Feeling (one word)
• Fact (one specific moment)
• Request (one next step)

If I start mind-reading or stacking examples, call me back to one moment.`,
`I want reassurance — and I want it without forcing you to accept blame you don’t own.

Please respond to one specific moment. If I’m using “always/never,” I’ll tighten it.`,
`I’m not trying to control you. I’m trying to feel safe.

If I’m pressuring for an apology or proof, I’ll pause and ask for a concrete reassurance instead.`
  ];
  const P2 = [
`I care about what you’re feeling. I also need us to stay grounded.

I can validate feelings without validating a false story.
Let’s separate:
• what happened (facts)
• what we think it means (guesses)
• what we want next (request).`,
`I’m here. I’m not going to argue your feelings.

I will respond to specifics — not broad accusations.
Give me one moment, and I’ll meet it honestly.`,
`I’m staying respectful — and I’m not doing pressure-based repair.

If this turns into insults, threats, or “prove it right now,” I’m pausing and we’ll return at a set time.`
  ];
  const T = [
`Team mode.

We’re on the same side, facing the same loop.
Step 1: name the feeling (no accusations).
Step 2: confirm one fact.
Step 3: make one request.
Step 4: choose one repair action (small, real, today).`,
`We can hold two truths:
1) feelings matter
2) stories get verified

Let’s slow down, pick one moment, and aim for one next step — not a courtroom.`,
`If we’re getting sharp, we pause. Not abandonment — protection.
Return time: __:__.
When we come back: feeling → fact → request → repair.`
  ];

  const base = view==="P1" ? P1 : (view==="P2" ? P2 : T);
  const opener = base[Math.min(stepId-1, base.length-1)];
  const stepHint = `\n\nRight now we’re at Step ${s.id} — ${s.title}.`;
  const micro = `\nMicro-move: ${s.interrupt[0]}`;
  const session = running ? "\n\nLane: empathy + accuracy + limits." : "";
  return `${opener}${stepHint}${micro}${cutoffLine}${session}`;
}

function defaultInvite(){
return `Relationship Playbook for Fulfillment and Care to help us better understand and navigate some recurring loops we get caught in. It’s a shared framework for communication, trust, and responsibility — so we can both feel valued, supported, and emotionally safe.

This playbook isn’t about blame. It’s about:
• recognizing patterns early
• making needs visible
• validating feelings without distorting reality
• building trust through consistent care + clean agreements

I’d love for us to review it together when we’re calm and pick 1–2 small practices to try this week.

Thank you for being willing to explore.`;
}
function defaultInvite(){
return `Relationship Playbook for Fulfillment and Care to help us better understand and navigate some of the challenges we’ve been facing. It’s a clear, shared framework that covers the emotional loops we get caught in, communication struggles, trust issues, and how we can both take responsibility for creating a stronger, more fulfilling partnership.

This playbook isn’t about blame—it’s about recognizing patterns, making our needs visible, and building trust and care in ways that honor both of us. It also addresses how harshness and difficulty expressing needs in a positive way can make it hard to meet those needs, and the trust challenges that come from past experiences.

I believe that by working through this together—balancing visionary drive with grounded optimism—we can break negative loops, communicate more openly, and create a relationship where we both feel valued, supported, and emotionally safe.

I’d love for us to review this together and talk about how we can put it into practice.

Thank you for being willing to explore.`;
}
function defaultCutoff(){
return `I care about you, and I care about us.

I’m noticing we’re looping / getting sharp, and I don’t want us to say things we can’t take back.

I’m going to pause this conversation now. Let’s take 20–30 minutes, reset, and come back at __:__.

When we return: we’ll name the feeling, confirm one fact, and make one clear request.

This isn’t abandonment — it’s protection.`;
}

const K = {
  profile: "lb_profile",
  step: "lb_step",
  cutoff: "lb_cutoff",
  running: "lb_running",
  start: "lb_start_ts",
  invite: "lb_invite",
  cutoffScript: "lb_cutoff_script",
  weekly: "lb_weekly_notes",
  ttsText: "lb_tts_text",
  ttsStyle: "lb_tts_style",
  voice: "lb_voice_uri",
  tracks: "lb_tracks",
  rate: "lb_rate",
  loopmode: "lb_loopmode",
  logP1: "lb_log_P1",
  logP2: "lb_log_P2",
  joint: "lb_joint_notes",
};

function safeSet(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
function safeGet(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function nowISO(){ return new Date().toISOString(); }
function fmtTime(iso){
  try{ return new Date(iso).toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"}); }
  catch(e){ return "—"; }
}
function escapeHtml(s){
  return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

const tabs = document.querySelectorAll(".tab");
const tabMoment = document.getElementById("tab-moment");
const tabJournal = document.getElementById("tab-journal");
const tabPlaybook = document.getElementById("tab-playbook");

const profileSel = document.getElementById("profile");
const stepSel = document.getElementById("step-select");
const cutoffSel = document.getElementById("cutoff");

const scriptEl = document.getElementById("script-text");
const anchorList = document.getElementById("anchor-list");

const btnStart = document.getElementById("btn-start");
const btnStop = document.getElementById("btn-stop");
const sessionLabel = document.getElementById("session-label");
const cutLabel = document.getElementById("cut-label");
const cutDot = document.getElementById("cut-dot");

const factsEl = document.getElementById("log-facts");
const needEl = document.getElementById("log-need");
const btnSave = document.getElementById("btn-save");
const btnClearFields = document.getElementById("btn-clear-fields");

const searchEl = document.getElementById("search");
const filterStep = document.getElementById("filter-step");
const logList = document.getElementById("log-list");
const btnClearLog = document.getElementById("btn-clear-log");

const kCount = document.getElementById("k-count");
const kLast = document.getElementById("k-last");
const kMode = document.getElementById("k-mode");

const pbIntro = document.getElementById("pb-intro");
const pbWeekly = document.getElementById("pb-weekly");
const cutoffScriptEl = document.getElementById("cutoff-script");

const btnExport = document.getElementById("btn-export");
const btnExport2 = document.getElementById("btn-export2");
const btnReset = document.getElementById("btn-reset");

const btnSpeak = document.getElementById("btn-speak");
const btnCopy = document.getElementById("btn-copy");

const fvInput = document.getElementById("fv-input");
const fvOutput = document.getElementById("fv-output");
const btnFV = document.getElementById("btn-fv");
const btnFVS = document.getElementById("btn-fv-speak");

const btnInviteSpeak = document.getElementById("btn-invite-speak");
const btnInviteCopy = document.getElementById("btn-invite-copy");
const btnResetIntro = document.getElementById("btn-reset-intro");
const btnClearIntro = document.getElementById("btn-clear-intro");
const btnCutSpeak = document.getElementById("btn-cut-speak");
const btnCutCopy = document.getElementById("btn-cut-copy");

const btnTTSStop = document.getElementById("btn-tts-stop");
const voiceSel = document.getElementById("voice");
const ttsStyleSel = document.getElementById("tts-style");
const btnTTSSpeak = document.getElementById("btn-tts-speak");
const btnTTSPaste = document.getElementById("btn-tts-paste-script");
const ttsText = document.getElementById("tts-text");

const audio = document.getElementById("audio");
const playlistEl = document.getElementById("playlist");
const btnAddTrack = document.getElementById("btn-add-track");
const btnClearTracks = document.getElementById("btn-clear-tracks");
const rateEl = document.getElementById("rate");
const loopModeEl = document.getElementById("loopmode");

const loopStrip = document.getElementById("loop-strip");
const dTitle = document.getElementById("d-title");
const dWhat = document.getElementById("d-what");
const dThem = document.getElementById("d-them");
const dYou = document.getElementById("d-you");
const dInterrupt = document.getElementById("d-interrupt");

let activeStep = 1;

function renderLoopStrip(){
  loopStrip.innerHTML = "";
  LOOP.forEach((s,idx)=>{
    const el = document.createElement("div");
    el.className = "step";
    el.dataset.id = s.id;
    el.innerHTML = `<div class="step-tag">${s.tag}</div>
      <div class="step-title">${s.id}. ${s.title}</div>
      <div class="step-sub">${s.short}</div>`;
    el.addEventListener("click", ()=>setStep(s.id,true));
    loopStrip.appendChild(el);
    if(idx<LOOP.length-1){
      const a = document.createElement("div");
      a.className = "arrow";
      a.textContent = "➜";
      loopStrip.appendChild(a);
    }
  });
}

function setStep(id, syncSelect=false){
  activeStep = id;
  document.querySelectorAll(".step").forEach(x=>x.classList.remove("active"));
  const c = document.querySelector(`.step[data-id="${id}"]`);
  if(c) c.classList.add("active");

  const s = LOOP.find(x=>x.id===id) || LOOP[0];
  dTitle.textContent = `Step ${s.id} — ${s.title}`;
  dWhat.textContent = s.what;
  dThem.textContent = `Partner 1: ${s.p1}`;
  dYou.textContent = `Partner 2: ${s.p2}`;
  dInterrupt.innerHTML = "";
  s.interrupt.forEach(i=>{
    const li = document.createElement("li");
    li.textContent = i;
    dInterrupt.appendChild(li);
  });

  if(syncSelect){
    stepSel.value = String(id);
    safeSet(K.step, id);
  }
  refreshScript();
}

function renderAnchors(){
  anchorList.innerHTML="";
  ANCHORS.forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    anchorList.appendChild(li);
  });
}

const tabExercises = document.getElementById("tab-exercises");
function showTab(which){
  tabMoment.style.display = which==="moment" ? "" : "none";
  tabJournal.style.display = which==="journal" ? "" : "none";
  tabPlaybook.style.display = which==="playbook" ? "" : "none";
  if(tabExercises) tabExercises.style.display = which==="exercises" ? "" : "none";
  tabs.forEach(t=>t.classList.toggle("active", t.dataset.tab===which));
  if(which==="journal") renderLog();
}
tabs.forEach(t=>t.addEventListener("click", ()=>showTab(t.dataset.tab)));

let timer = null;
let running = false;

function updateSessionUI(){
  if(!running){
    sessionLabel.textContent = "Session: ready";
    cutLabel.textContent = "Cutoff: not set";
    cutDot.style.display = "none";
    return;
  }
  const start = safeGet(K.start, null);
  const cut = Number(cutoffSel.value || 0);
  const elapsed = start ? Math.max(0, Math.floor((Date.now() - start)/1000)) : 0;

  sessionLabel.textContent = `Session: ${Math.floor(elapsed/60)}m ${elapsed%60}s`;
  if(cut>0){
    const left = Math.max(0, cut*60 - elapsed);
    cutLabel.textContent = `Cutoff: ${Math.floor(left/60)}m ${left%60}s left`;
    cutDot.style.display = left<=60 ? "" : "none";
  }else{
    cutLabel.textContent = "Cutoff: none";
    cutDot.style.display = "none";
  }
}

function startSession(){
  running = true;
  safeSet(K.running, true);
  safeSet(K.start, Date.now());
  updateSessionUI();
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    updateSessionUI();
    const cut = Number(cutoffSel.value || 0);
    const start = safeGet(K.start, null);
    if(running && cut>0 && start){
      const elapsed = Math.floor((Date.now() - start)/1000);
      if(elapsed >= cut*60){
        cutDot.style.display = "";
        cutLabel.textContent = "Cutoff: reached (pause + return time)";
        if((ttsText.value||"").trim().length===0){
          ttsText.value = cutoffScriptEl.value || defaultCutoff();
          safeSet(K.ttsText, ttsText.value);
        }
      }
    }
  }, 500);
  refreshScript();
}

function stopSession(){
  running = false;
  safeSet(K.running, false);
  safeSet(K.start, null);
  if(timer) clearInterval(timer);
  timer = null;
  updateSessionUI();
  refreshScript();
}

btnStart.addEventListener("click", startSession);
btnStop.addEventListener("click", stopSession);

function refreshScript(){
  const profile = profileSel.value;
  const cut = Number(cutoffSel.value || 0);
  const txt = buildScript(profile, activeStep, cut, running);
  scriptEl.textContent = txt;
}

function copyText(txt){
  navigator.clipboard?.writeText(txt).catch(()=>{});
}
btnCopy.addEventListener("click", ()=>copyText(scriptEl.textContent));
btnInviteCopy.addEventListener("click", ()=>copyText(pbIntro.value));
btnCutCopy.addEventListener("click", ()=>copyText(cutoffScriptEl.value));

const FEELINGS = ["sad","hurt","scared","angry","frustrated","lonely","anxious","overwhelmed","disrespected","dismissed","unseen","unimportant","jealous","ashamed","guilty","confused","tired","resentful","unsafe","tense"];
function translateFeelVsThink(s){
  const raw = (s||"").trim();
  if(!raw) return "";
  const lower = raw.toLowerCase();
  const isThoughtMask = lower.includes("i feel") && (lower.includes("you ") || lower.includes("that ") || lower.includes("like ") || lower.includes("never") || lower.includes("always"));
  const feelingWord = FEELINGS.find(f=>lower.includes("i feel "+f) || lower.includes("feel "+f)) || null;
  const feeling = feelingWord ? feelingWord : (isThoughtMask ? "hurt / anxious (pick one)" : "___");
  const observation = "Observation: (one concrete moment) ______";
  const request = "Request: (one specific next step) ______";
  const note = isThoughtMask
    ? "Note: that sentence is a thought/interpretation. Convert it to a feeling + observation + request."
    : "Note: keep it short, concrete, and non-accusatory.";
  return `Feeling: ${feeling}\n${observation}\nMeaning (optional, labeled as guess): ______\n${request}\n\n${note}`;
}
btnFV.addEventListener("click", ()=>{ fvOutput.value = translateFeelVsThink(fvInput.value); });

function getLogKey(){ return profileSel.value==="P2" ? K.logP2 : K.logP1; }
function getLog(){ return safeGet(getLogKey(), []); }
function setLog(arr){ safeSet(getLogKey(), arr); updateKPIs(); }

function saveEntry(){
  const facts = (factsEl.value||"").trim();
  const need = (needEl.value||"").trim();
  if(!facts && !need) return;
  const entry = { id: Math.random().toString(16).slice(2), ts: nowISO(), profile: profileSel.value, stepId: activeStep, facts, need };
  const log = getLog();
  log.unshift(entry);
  setLog(log);
  factsEl.value = "";
  needEl.value = "";
  renderLog();
}
btnSave.addEventListener("click", saveEntry);
btnClearFields.addEventListener("click", ()=>{factsEl.value="";needEl.value="";});
[factsEl, needEl].forEach(el=>{
  el.addEventListener("keydown", (e)=>{ if(e.ctrlKey && e.key==="Enter"){ e.preventDefault(); saveEntry(); } });
});

function updateKPIs(){
  const log = getLog();
  kCount.textContent = String(log.length);
  kLast.textContent = log[0]?.ts ? fmtTime(log[0].ts) : "—";
  kMode.textContent = profileSel.value;
}

function renderLog(){
  const q = (searchEl.value||"").toLowerCase().trim();
  const f = filterStep.value || "all";
  const log = getLog();
  const filtered = log.filter(e=>{
    const matchesQ = !q || (e.facts||"").toLowerCase().includes(q) || (e.need||"").toLowerCase().includes(q);
    const matchesF = (f==="all") || (String(e.stepId)===String(f));
    return matchesQ && matchesF;
  });
  logList.innerHTML = "";
  if(filtered.length===0){
    const empty = document.createElement("div");
    empty.className = "entry";
    empty.innerHTML = `<div class="meta">No entries yet. Use <code>In‑Moment</code> → <code>Save Entry</code>.</div>`;
    logList.appendChild(empty);
  }else{
    filtered.forEach(e=>{
      const s = LOOP.find(x=>x.id===e.stepId);
      const wrap = document.createElement("div");
      wrap.className = "entry";
      wrap.innerHTML = `
        <div class="meta">
          <code>${e.profile}</code>
          <code>Step ${e.stepId}</code>
          <span>${fmtTime(e.ts)}</span>
          <span class="spacer"></span>
          <button class="btn small danger" data-del="${e.id}">Delete</button>
        </div>
        <div class="txt"><strong>${s ? s.title : "Step"}</strong>\n\nFacts:\n${escapeHtml(e.facts)}\n\nFeeling/Need:\n${escapeHtml(e.need)}</div>
      `;
      wrap.querySelector("[data-del]")?.addEventListener("click", ()=>{
        const id = e.id;
        const next = getLog().filter(x=>x.id!==id);
        setLog(next);
        renderLog();
      });
      logList.appendChild(wrap);
    });
  }
  updateKPIs();
}
searchEl.addEventListener("input", renderLog);
filterStep.addEventListener("change", renderLog);
btnClearLog.addEventListener("click", ()=>{
  safeSet(getLogKey(), []);
  renderLog();
});

function exportAll(){
  const payload = {
    exportedAt: nowISO(),
    profile: profileSel.value,
    settings: { step: activeStep, cutoff: Number(cutoffSel.value||0), running: running },
    playbook: { invite: pbIntro.value, cutoffScript: cutoffScriptEl.value, weeklyNotes: pbWeekly.value },
    media: { tracks: safeGet(K.tracks, []), rate: Number(rateEl.value||1), loopmode: loopModeEl.value },
    log: getLog()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `loop_breaker_v3_${profileSel.value}_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}
btnExport.addEventListener("click", exportAll);
btnExport2.addEventListener("click", exportAll);

btnReset.addEventListener("click", ()=>{
  if(!confirm("Reset all local data for this workbook (settings, logs, playbook, media)?")) return;
  Object.values(K).forEach(k=>{ try{ localStorage.removeItem(k); }catch(e){} });
  location.reload();
});

profileSel.addEventListener("change", ()=>{
  safeSet(K.profile, profileSel.value);
  renderLog();
  refreshScript();
});
stepSel.addEventListener("change", ()=>{ setStep(Number(stepSel.value||1), true); });
cutoffSel.addEventListener("change", ()=>{ safeSet(K.cutoff, Number(cutoffSel.value||0)); refreshScript(); });

pbIntro.addEventListener("input", ()=>safeSet(K.invite, pbIntro.value));
pbWeekly.addEventListener("input", ()=>safeSet(K.weekly, pbWeekly.value));
cutoffScriptEl.addEventListener("input", ()=>safeSet(K.cutoffScript, cutoffScriptEl.value));

btnResetIntro.addEventListener("click", ()=>{ pbIntro.value = defaultInvite(); safeSet(K.invite, pbIntro.value); });
btnClearIntro.addEventListener("click", ()=>{ pbIntro.value = ""; safeSet(K.invite, ""); });

/* TTS */
let voices = [];
function loadVoices(){
  if(!("speechSynthesis" in window)) return;
  voices = window.speechSynthesis.getVoices() || [];
  voiceSel.innerHTML = "";
  voices.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSel.appendChild(opt);
  });
  const saved = safeGet(K.voice, "");
  if(saved && voices.find(v=>v.voiceURI===saved)) voiceSel.value = saved;
  else{
    const pref = voices.find(v=>/en-US/i.test(v.lang) && /Google|Samantha|Alex|Zira|Natural|Neural/i.test(v.name))
      || voices.find(v=>/en-US/i.test(v.lang)) || voices[0];
    if(pref) voiceSel.value = pref.voiceURI;
  }
}
window.speechSynthesis?.addEventListener?.("voiceschanged", loadVoices);
setTimeout(loadVoices, 250);

function stopSpeech(){ try{ window.speechSynthesis.cancel(); }catch(e){} }
btnTTSStop.addEventListener("click", stopSpeech);

function speak(text){
  if(!("speechSynthesis" in window)) return;
  stopSpeech();
  const t = (text||"").trim();
  if(!t) return;
  const u = new SpeechSynthesisUtterance(t);
  const style = ttsStyleSel.value || "calm";
  if(style==="calm"){ u.rate=0.96; u.pitch=1.0; u.volume=1.0; }
  if(style==="coach"){ u.rate=1.03; u.pitch=1.05; u.volume=1.0; }
  if(style==="neutral"){ u.rate=1.0; u.pitch=1.0; u.volume=1.0; }
  const chosen = voices.find(v=>v.voiceURI===voiceSel.value);
  if(chosen) u.voice = chosen;
  window.speechSynthesis.speak(u);
}
btnSpeak.addEventListener("click", ()=>speak(scriptEl.textContent));
btnInviteSpeak.addEventListener("click", ()=>speak(pbIntro.value));
btnCutSpeak.addEventListener("click", ()=>speak(cutoffScriptEl.value));
btnFVS.addEventListener("click", ()=>speak(fvOutput.value || ""));
btnTTSSpeak.addEventListener("click", ()=>speak(ttsText.value));
btnTTSPaste.addEventListener("click", ()=>{ ttsText.value = scriptEl.textContent; safeSet(K.ttsText, ttsText.value); });
voiceSel.addEventListener("change", ()=>safeSet(K.voice, voiceSel.value));
ttsStyleSel.addEventListener("change", ()=>safeSet(K.ttsStyle, ttsStyleSel.value));
ttsText.addEventListener("input", ()=>safeSet(K.ttsText, ttsText.value));

/* Media playlist */
function getTracks(){ return safeGet(K.tracks, []); }
function setTracks(t){ safeSet(K.tracks, t); renderPlaylist(); }
let currentIndex = 0;

function renderPlaylist(){
  const tracks = getTracks();
  playlistEl.innerHTML = "";
  if(tracks.length===0){
    const e = document.createElement("div");
    e.className = "entry";
    e.innerHTML = `<div class="meta">No tracks yet. Click <code>Add Track</code>.</div>`;
    playlistEl.appendChild(e);
    audio.removeAttribute("src");
    return;
  }
  tracks.forEach((tr, idx)=>{
    const e = document.createElement("div");
    e.className = "entry";
    const active = idx===currentIndex;
    e.innerHTML = `
      <div class="meta">
        <code>${active ? "▶" : " "}</code>
        <span>${escapeHtml(tr.name || ("Track "+(idx+1)))}</span>
        <span class="spacer"></span>
        <button class="btn small" data-play="${idx}">Play</button>
        <button class="btn small danger" data-del="${idx}">Del</button>
      </div>
      <div class="mini">${escapeHtml(tr.url || "")}</div>
    `;
    e.querySelector("[data-play]")?.addEventListener("click", ()=>playIndex(idx,true));
    e.querySelector("[data-del]")?.addEventListener("click", ()=>{
      const t = getTracks();
      t.splice(idx,1);
      if(currentIndex>=t.length) currentIndex = Math.max(0, t.length-1);
      setTracks(t);
      if(t.length>0) playIndex(currentIndex,false);
    });
    playlistEl.appendChild(e);
  });
}
function playIndex(idx, autoplay){
  const tracks = getTracks();
  if(!tracks[idx]) return;
  currentIndex = idx;
  audio.src = tracks[idx].url;
  audio.playbackRate = Number(rateEl.value||1);
  audio.loop = (loopModeEl.value==="track");
  renderPlaylist();
  if(autoplay) audio.play().catch(()=>{});
}
audio.addEventListener("ended", ()=>{
  const mode = loopModeEl.value;
  const tracks = getTracks();
  if(mode==="track") return;
  if(mode==="playlist" && tracks.length>0){
    playIndex((currentIndex+1)%tracks.length, true);
  }
});
btnAddTrack.addEventListener("click", ()=>{
  const url = prompt("Paste an audio URL (mp3/ogg/wav):");
  if(!url) return;
  const name = prompt("Track name (optional):") || url.split("/").slice(-1)[0] || "Track";
  const t = getTracks();
  t.push({name, url});
  setTracks(t);
  if(t.length===1) playIndex(0,false);
});
btnClearTracks.addEventListener("click", ()=>{ if(confirm("Clear playlist?")) setTracks([]); });
rateEl.addEventListener("input", ()=>{ safeSet(K.rate, Number(rateEl.value||1)); audio.playbackRate = Number(rateEl.value||1); });
loopModeEl.addEventListener("change", ()=>{ safeSet(K.loopmode, loopModeEl.value); audio.loop = (loopModeEl.value==="track"); });

function initSelects(){
  stepSel.innerHTML = "";
  LOOP.forEach(s=>{
    const o = document.createElement("option");
    o.value = String(s.id);
    o.textContent = `Step ${s.id} — ${s.title}`;
    stepSel.appendChild(o);
    const f = document.createElement("option");
    f.value = String(s.id);
    f.textContent = `Step ${s.id} — ${s.title}`;
    filterStep.appendChild(f);
  });
}


/* Exercises (joint drills) */
const EX = [
  {
    id:"two-minute-reset",
    name:"2-minute Reset (in the moment)",
    text:`1) Both take 3 slow breaths.\n2) Each says ONE feeling word.\n3) Each says ONE fact (no meaning).\n4) Each makes ONE request (specific next step).\n\nClose with: “Same team. One step.”`
  },
  {
    id:"feelings-vs-thoughts",
    name:"Feelings vs Thoughts (clean language)",
    text:`Practice converting:\n“I feel you don’t care.” → “I feel hurt/lonely. When __ happened, I needed __. Can we __?”\n\nRule: feelings are emotions; thoughts are interpretations. We label thoughts as guesses.`
  },
  {
    id:"reflect-and-verify",
    name:"Reflect + Verify (no mind-reading)",
    text:`Partner A speaks 30–60 seconds.\nPartner B reflects: “What I heard is __. Did I get it?”\nThen verify ONE fact: “The moment was __ at __. Correct?”\nThen request ONE next step.`
  },
  {
    id:"repair-3x3",
    name:"Repair 3×3 (after a spike)",
    text:`Each partner answers 3 questions in 3 minutes:\n1) What impact did my behavior have?\n2) What do I wish I had done instead?\n3) What can I do in the next 24h to rebuild trust?\n\nPick ONE action each and do it today.`
  },
  {
    id:"protected-time",
    name:"Protected Time Planning (weekly)",
    text:`Pick 2–3 connection blocks.\nPick 1 solo block each.\nPick 1 weekly check-in time.\n\nAgreement: play/work happens after connection blocks are honored.`
  }
];

const exPick = document.getElementById("exercise-pick");
const exText = document.getElementById("exercise-text");
const exGood = document.getElementById("ex-good");
const exAdjust = document.getElementById("ex-adjust");
const btnExSpeak = document.getElementById("btn-ex-speak");
const btnExCopy = document.getElementById("btn-ex-copy");
const btnExSave = document.getElementById("btn-ex-save");
const btnExClear = document.getElementById("btn-ex-clear");

function renderExercises(){
  if(!exPick) return;
  exPick.innerHTML = "";
  EX.forEach(x=>{
    const o=document.createElement("option");
    o.value=x.id; o.textContent=x.name;
    exPick.appendChild(o);
  });
  const savedId = safeGet("lb_ex_pick","two-minute-reset");
  exPick.value = EX.find(x=>x.id===savedId) ? savedId : EX[0].id;
  showExercise(exPick.value);
}

function showExercise(id){
  const x = EX.find(e=>e.id===id) || EX[0];
  safeSet("lb_ex_pick", x.id);
  if(exText) exText.textContent = x.text;
}

exPick?.addEventListener("change", ()=>showExercise(exPick.value));
btnExCopy?.addEventListener("click", ()=>copyText(exText?.textContent || ""));
btnExSpeak?.addEventListener("click", ()=>speak(exText?.textContent || ""));

function loadJoint(){
  const j = safeGet(K.joint, {good:"", adjust:""});
  if(exGood) exGood.value = j.good || "";
  if(exAdjust) exAdjust.value = j.adjust || "";
}
function saveJoint(){
  safeSet(K.joint, {good: (exGood?.value||""), adjust:(exAdjust?.value||"")});
}
btnExSave?.addEventListener("click", saveJoint);
btnExClear?.addEventListener("click", ()=>{
  if(exGood) exGood.value="";
  if(exAdjust) exAdjust.value="";
  saveJoint();
});
exGood?.addEventListener("input", saveJoint);
exAdjust?.addEventListener("input", saveJoint);

function init(){
  initSelects();
  renderLoopStrip();
  renderAnchors();
  renderExercises();
  loadJoint();

  profileSel.value = safeGet(K.profile, "P1");
  activeStep = safeGet(K.step, 1);
  stepSel.value = String(activeStep);
  cutoffSel.value = String(safeGet(K.cutoff, 0));

  ttsStyleSel.value = safeGet(K.ttsStyle, "calm");
  ttsText.value = safeGet(K.ttsText, "");
  pbIntro.value = safeGet(K.invite, defaultInvite());
  cutoffScriptEl.value = safeGet(K.cutoffScript, defaultCutoff());
  pbWeekly.value = safeGet(K.weekly, "");

  rateEl.value = String(safeGet(K.rate, 1));
  loopModeEl.value = safeGet(K.loopmode, "track");
  audio.playbackRate = Number(rateEl.value||1);
  audio.loop = (loopModeEl.value==="track");

  running = safeGet(K.running, false);
  if(running){
    const st = safeGet(K.start, null);
    if(!st) safeSet(K.start, Date.now());
    startSession();
  }else{
    updateSessionUI();
  }

  setStep(activeStep, false);
  renderPlaylist();
  updateKPIs();
  renderLog();
  refreshScript();
}
init();

document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") stopSpeech(); });
</script>
</body>
</html>
