<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loop Breaker ‚Äî In‚ÄëMoment + Journal Workbook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg0:#05070a; --bg1:#0a0f16;
      --card:#101722; --card2:#141d2a; --card3:#0d121b;
      --accent:#7fffd4; --accent2:#ffb86c; --danger:#ff6b81; --ink:#f5f7fb; --muted:#9aa3ba;
      --line:#232c3a; --pill:#1a2433;
      --shadow:0 18px 40px rgba(0,0,0,.62);
      --r-lg:18px; --r-md:12px; --r-pill:999px;
      --t:.18s ease-out;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #101728 0, var(--bg0) 42%);
      min-height:100vh;
    }
    .page{max-width:1180px;margin:0 auto;padding:18px 14px 40px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;justify-content:space-between;margin-bottom:14px}
    h1{margin:0;font-size:1.55rem;letter-spacing:.03em}
    .sub{margin:6px 0 0;max-width:760px;color:var(--muted);font-size:.92rem;line-height:1.35}
    .top-right{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}
    .pill{padding:6px 10px;border-radius:var(--r-pill);background:var(--pill);border:1px solid rgba(127,255,212,.14);color:var(--muted);font-size:.74rem;letter-spacing:.08em;text-transform:uppercase}
    .btn{
      border-radius:var(--r-pill); border:1px solid var(--line);
      background:var(--pill); color:var(--muted);
      padding:8px 12px; font-size:.82rem; cursor:pointer;
      transition:transform var(--t), border-color var(--t), color var(--t), background var(--t);
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(127,255,212,.65);color:var(--accent)}
    .btn.danger:hover{border-color:rgba(255,107,129,.75);color:var(--danger)}
    .btn.accent{border-color:rgba(127,255,212,.45);color:var(--accent)}
    .btn.accent:hover{background:rgba(127,255,212,.08)}
    .btn.small{padding:6px 10px;font-size:.78rem}
    .grid{display:grid;grid-template-columns:minmax(0,1.05fr) minmax(0,1fr);gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:minmax(0,1fr)}}
    .card{
      background:rgba(5,7,10,.56);
      border:1px solid var(--line);
      border-radius:var(--r-lg);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h2{margin:0 0 8px;font-size:1rem;letter-spacing:.02em}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .spacer{flex:1}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:10px 0}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{
      padding:7px 10px;border-radius:var(--r-pill);
      border:1px solid var(--line);
      background:var(--card3);
      color:var(--muted);
      font-size:.8rem;cursor:pointer;
      transition: border-color var(--t), color var(--t), transform var(--t), background var(--t);
    }
    .tab:hover{transform:translateY(-1px);border-color:rgba(127,255,212,.55);color:var(--accent)}
    .tab.active{background:linear-gradient(135deg,#1b2838,#243348);border-color:var(--accent);color:var(--accent)}
    .loop-strip{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;scrollbar-width:thin;scrollbar-color:rgba(127,255,212,.18) transparent}
    .loop-strip::-webkit-scrollbar{height:6px}
    .loop-strip::-webkit-scrollbar-thumb{background:rgba(127,255,212,.18);border-radius:999px}
    .step{
      min-width:178px;max-width:215px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:10px 10px 12px;
      cursor:pointer;
      transition: transform var(--t), border-color var(--t), box-shadow var(--t), background var(--t);
    }
    .step:hover{transform:translateY(-2px);border-color:rgba(127,255,212,.5);box-shadow:0 10px 28px rgba(0,0,0,.7)}
    .step.active{background:linear-gradient(145deg,#111a28,#182538);border-color:var(--accent);box-shadow:0 16px 34px rgba(0,0,0,.9)}
    .step-tag{font-size:.64rem;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
    .step-title{font-size:.9rem;font-weight:650;margin-bottom:6px}
    .step-sub{font-size:.76rem;color:var(--muted);line-height:1.25}
    .arrow{align-self:center;color:rgba(255,255,255,.5)}
    .two{display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);gap:10px}
    @media (max-width:820px){.two{grid-template-columns:minmax(0,1fr)}}
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:10px 12px;
    }
    .panel h3{margin:0 0 6px;font-size:.88rem}
    .panel p,.panel ul{margin:0;color:var(--muted);font-size:.83rem;line-height:1.38}
    .panel ul{padding-left:18px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{
      font-size:.72rem;border-radius:var(--r-pill);
      padding:3px 9px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--muted)
    }
    .chip.a{border-color:rgba(127,255,212,.55);color:var(--accent)}
    .chip.b{border-color:rgba(255,184,108,.6);color:var(--accent2)}
    .chip.d{border-color:rgba(255,107,129,.7);color:var(--danger)}
    textarea, input[type="text"], select{
      width:100%;
      border-radius:var(--r-md);
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--ink);
      padding:9px 10px;
      font-size:.84rem;
      outline:none;
      transition:border-color var(--t), box-shadow var(--t), background var(--t);
    }
    textarea{min-height:92px;max-height:420px;resize:vertical;line-height:1.35}
    textarea:focus,input[type="text"]:focus,select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(127,255,212,.3);
      background:#151f30;
    }
    .label{font-size:.78rem;color:var(--muted);margin-bottom:6px}
    .kpi{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px
    }
    @media (max-width:560px){.kpi{grid-template-columns:minmax(0,1fr)}}
    .k{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:10px 12px;
    }
    .k .n{font-family:var(--mono);font-size:1.05rem;color:var(--accent)}
    .k .t{font-size:.74rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-top:3px}
    .callout{
      border:1px solid rgba(127,255,212,.18);
      background:linear-gradient(145deg, rgba(127,255,212,.08), rgba(255,184,108,.05));
      border-radius:var(--r-md);
      padding:12px;
    }
    .callout strong{color:var(--accent)}
    .notice{font-size:.76rem;color:var(--muted);line-height:1.4;margin-top:8px}
    .hr{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .log{display:grid;gap:8px;max-height:420px;overflow:auto;padding-right:2px}
    .entry{border:1px solid var(--line);background:var(--card);border-radius:var(--r-md);padding:10px 12px}
    .entry .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:var(--muted);font-size:.75rem}
    .entry .meta code{font-family:var(--mono);font-size:.72rem;background:rgba(255,255,255,.04);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.06)}
    .entry .txt{margin-top:8px;color:var(--ink);font-size:.85rem;line-height:1.4;white-space:pre-wrap}
    .mini{font-size:.76rem;color:var(--muted)}
    .rightcol .card{position:sticky;top:12px}
    @media (max-width:980px){.rightcol .card{position:relative;top:auto}}
    audio{width:100%; margin-top:8px}
    .range{width:100%}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:.72rem;color:var(--muted);
      padding:4px 10px;border-radius:var(--r-pill);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(127,255,212,.35)}
    .dot.red{background:rgba(255,107,129,.5)}
    .dot.amber{background:rgba(255,184,108,.5)}
    .kbd{
      font-family:var(--mono);
      font-size:.73rem;
      padding:2px 7px;
      border-radius:9px;
      border:1px solid rgba(255,255,255,.1);
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
    details{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:10px 12px;
      margin-top:10px;
      transition:border-color var(--t), background var(--t);
    }
    details[open]{border-color:rgba(127,255,212,.5);background:linear-gradient(145deg,#111a28,#182538)}
    summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .sum-left{display:flex;align-items:center;gap:10px}
    .sum-emoji{font-size:1.05rem}
    .sum-title{font-weight:650;font-size:.92rem}
    .sum-sub{font-size:.78rem;color:var(--muted);margin-top:2px}
    .sum-right{color:var(--muted);font-size:.78rem}
    .pb-body{margin-top:10px;color:var(--muted);font-size:.84rem;line-height:1.45}
    .pb-body ul{margin:8px 0 0;padding-left:18px}
    .pb-body li{margin:6px 0}
    .mini-grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:10px;margin-top:10px}
    @media (max-width:780px){.mini-grid{grid-template-columns:minmax(0,1fr)}}
    .quote{
      background:rgba(255,255,255,.03);
      border:1px dashed rgba(127,255,212,.22);
      border-radius:var(--r-md);
      padding:10px 10px;
      color:var(--ink);
      font-size:.82rem;
      line-height:1.45;
    }
    .quote .who{display:inline-block;margin-bottom:6px;font-size:.72rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>Loop Breaker ‚Äî In‚ÄëMoment + Journal</h1>
        <p class="sub">
          Built for real-time use: validate feelings, protect truth, keep your energy, set compassionate cutoffs, and log it clean.
          <span class="muted">No reality-bending. No emotional hostage situations.</span>
          <br><span class="muted">Designed to be fair to both partners ‚Äî with language that actively supports feelings + needs, while still keeping conversations safe and grounded.</span>
        </p>
        <div class="row" style="margin-top:10px;gap:8px">
          <span class="pill">A‚Äëstride swagger</span>
          <span class="pill">empathy + boundaries</span>
          <span class="pill">In‚Äëmoment scripts</span>
          <span class="pill">journal + playback</span>
        </div>
      </div>
      <div class="top-right">
        <span class="badge"><span class="dot"></span><span>Autosave: On</span></span>
        <button class="btn small" id="btn-export">Export JSON</button>
        <button class="btn small danger" id="btn-reset">Reset All</button>
      </div>
    </header>

    <div class="grid">
      <div class="leftcol">
        <div class="card">
          <div class="row">
            <h2 style="margin:0">Mode</h2>
            <div class="tabs" id="tabs">
              <button class="tab active" data-tab="moment">In‚ÄëMoment</button>
              <button class="tab" data-tab="journal">Journal</button>
              <button class="tab" data-tab="playbook">Playbook</button>
              <button class="tab" data-tab="exercises">Exercises</button>
            </div>
            <div class="spacer"></div>
            <div class="row" style="gap:8px">
              <span class="badge" id="session-label-wrap"><span class="dot amber"></span><span id="session-label">Session: ready</span></span>
              <span class="badge"><span class="dot red" id="cut-dot" style="display:none"></span><span id="cut-label">Cutoff: not set</span></span>
            </div>
          </div>

          <div class="divider"></div>

          <div id="tab-moment">
            <div class="row" style="gap:10px; align-items:flex-end">
              <div style="min-width:220px;flex:1">
                <div class="label">View</div>
                <select id="profile">
                  <option value="P1">Partner 1</option>
                  <option value="P2">Partner 2</option>
                  <option value="T">Together</option>
                </select>
              </div>
              <div style="min-width:220px;flex:1">
                <div class="label">Where are we in the loop?</div>
                <select id="step-select"></select>
              </div>
              <div style="min-width:220px;flex:1">
                <div class="label">Cutoff timer (compassionate exit)</div>
                <select id="cutoff">
                  <option value="0">No cutoff</option>
                  <option value="5">5 min</option>
                  <option value="10">10 min</option>
                  <option value="15">15 min</option>
                  <option value="20">20 min</option>
                  <option value="30">30 min</option>
                </select>
              </div>
              <button class="btn accent" id="btn-start">Start</button>
              <button class="btn danger" id="btn-stop">Stop</button>
            </div>

            <div class="hr"></div>

            <div class="callout">
              <div class="row">
                <h2 style="margin:0">Quick Script (scan + say it)</h2>
                <div class="spacer"></div>
                <button class="btn small" id="btn-speak">Speak</button>
                <button class="btn small" id="btn-copy">Copy</button>
              </div>
              <div class="divider"></div>
              <div id="script-text" style="white-space:pre-wrap;line-height:1.45;font-size:.9rem"></div>
              <div class="notice">
                <strong>Rule:</strong> Validate the <em>feeling</em>, but don‚Äôt validate a false story.
                If someone says ‚ÄúI feel‚Ä¶‚Äù followed by a thought/accusation, translate it back into a feeling + request.
              </div>
            </div>

            <div class="hr"></div>

            <div class="two">
              <div class="panel">
                <h3>Feel vs Think (fast translator)</h3>
                <p class="mini">Paste ‚ÄúI feel you don‚Äôt care‚Äù ‚Üí converts to feeling + observation + request.</p>
                <div class="divider"></div>
                <div class="label">Input</div>
                <input type="text" id="fv-input" placeholder="I feel like you never listen..." />
                <div class="row" style="margin-top:8px">
                  <button class="btn small" id="btn-fv">Translate</button>
                  <button class="btn small" id="btn-fv-speak">Speak</button>
                  <div class="spacer"></div>
                  <span class="mini">Keep it short + concrete.</span>
                </div>
                <div class="divider"></div>
                <div class="label">Output</div>
                <textarea id="fv-output" placeholder="Feeling: ...  Observation: ...  Request: ..."></textarea>
              </div>

              <div class="panel">
                <h3>Reality Anchor (protect truth)</h3>
                <p class="mini">Stay fair without becoming the emotional regulator.</p>
                <div class="divider"></div>
                <ul id="anchor-list"></ul>

                <div class="divider"></div>
                <div class="label">Common needs (choose 1)</div>
                <div class="chips" id="needs-chips"></div>
                <div class="chips">
                  <span class="chip a">Empathy ‚â† confession</span>
                  <span class="chip b">Feelings are real</span>
                  <span class="chip d">Stories get checked</span>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="panel">
              <div class="row">
                <h3 style="margin:0">One‚Äëtap Log (so it doesn‚Äôt spiral)</h3>
                <div class="spacer"></div>
                <span class="mini">Shortcut: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> saves.</span>
              </div>
              <div class="divider"></div>
              <div class="two">
                <div>
                  <div class="label">Facts (what actually happened)</div>
                  <textarea id="log-facts" placeholder="Facts only. Time, actions, words. No interpretation."></textarea>
                </div>
                <div>
                  <div class="label">Feeling + Need (clean + direct)</div>
                  <textarea id="log-need" placeholder="Feeling: ___  Need: ___  Request: ___"></textarea>
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn accent" id="btn-save">Save Entry</button>
                <button class="btn" id="btn-clear-fields">Clear Fields</button>
                <div class="spacer"></div>
                <span class="mini">Saved locally (per view).</span>
              </div>
            </div>
          </div>

          <div id="tab-journal" style="display:none">
            <div class="kpi">
              <div class="k"><div class="n" id="k-count">0</div><div class="t">entries saved</div></div>
              <div class="k"><div class="n" id="k-last">‚Äî</div><div class="t">last entry</div></div>
              <div class="k"><div class="n" id="k-mode">A</div><div class="t">current view</div></div>
            </div>

            <div class="hr"></div>

            <div class="row" style="gap:10px;align-items:flex-end">
              <div style="flex:1;min-width:220px">
                <div class="label">Search</div>
                <input type="text" id="search" placeholder="Type to filter entries..." />
              </div>
              <div style="min-width:200px">
                <div class="label">Filter by loop step</div>
                <select id="filter-step"><option value="all">All steps</option></select>
              </div>
              <div style="min-width:200px">
                <div class="label">Export / tools</div>
                <div class="row">
                  <button class="btn small" id="btn-export2">Export JSON</button>
                  <button class="btn small danger" id="btn-clear-log">Clear Log</button>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="log" id="log-list"></div>
          </div>

          <div id="tab-playbook" style="display:none">
            <div class="callout">
              <div class="row">
                <h2 style="margin:0">Playbook Invite</h2>
                <div class="spacer"></div>
                <button class="btn small" id="btn-invite-speak">Speak</button>
                <button class="btn small" id="btn-invite-copy">Copy</button>
              </div>
              <div class="divider"></div>
              <div class="label">Message (editable ‚Äî saved locally)</div>
              <textarea id="pb-intro" style="min-height:220px"></textarea>
              <div class="row" style="margin-top:10px">
                <button class="btn small" id="btn-reset-intro">Reset</button>
                <button class="btn small danger" id="btn-clear-intro">Clear</button>
                <div class="spacer"></div>
                <span class="mini">Read when calm, not mid‚Äëspike.</span>
              </div>
            </div>

            <div class="hr"></div>

            <div class="two">
              <div class="panel">
                <h3>Protected time (non‚Äënegotiable with love)</h3>
                <ul>
                  <li>2‚Äì3 couple blocks/week ‚Äî no work/gaming.</li>
                  <li>10‚Äëminute daily check‚Äëin (before bed / shared meal / call).</li>
                  <li>When conflict starts: agree on a cutoff timer and a return time.</li>
                </ul>
              </div>
              <div class="panel">
                <h3>Compassionate cutoff (exit script)</h3>
                <p class="mini">Stop spirals without punishing anyone.</p>
                <div class="divider"></div>
                <textarea id="cutoff-script" style="min-height:140px"></textarea>
                <div class="row" style="margin-top:8px">
                  <button class="btn small" id="btn-cut-speak">Speak</button>
                  <button class="btn small" id="btn-cut-copy">Copy</button>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="panel">
              <h3>Weekly check‚Äëin notes</h3>
              <textarea id="pb-weekly" placeholder="What felt good? What hurt? One adjustment. Effort noticed from each other."></textarea>
              <div class="notice"><strong>Pattern rule:</strong> defensiveness means "slow down," not "win."</div>
            </div>

            <div class="hr"></div>

            <div class="panel">
              <h3><span>How to Use</span><span style="font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-left:8px">10 minutes to start</span></h3>
              <ul style="margin:0;padding-left:18px;color:var(--muted);font-size:.83rem;line-height:1.45">
                <li>Pick <strong>one</strong> section below and read it together.</li>
                <li>Agree on <strong>one small experiment</strong> for the week.</li>
                <li>Use the Weekly Check-In prompts to track what changes.</li>
                <li>If you get caught in the loop, return to "Interrupting the Loop."</li>
              </ul>
              <div class="chips" style="margin-top:10px">
                <span class="chip a">A-stride: clarity + kindness</span>
                <span class="chip b">B-side: feelings + recognition</span>
                <span class="chip d">No blame frames</span>
              </div>
            </div>

            <div class="hr"></div>

            <details><summary><div class="sum-left"><div class="sum-emoji">üå±</div><div><div class="sum-title">Shared Agreements on Time</div><div class="sum-sub">Protect couple time so connection isn't optional</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li><strong>Protected Couple Time:</strong> Reserve 2‚Äì3 blocks per week for intentional connection, no work or gaming.</li>
                <li><strong>Daily Rituals:</strong> Commit to small daily check-ins (10 minutes before bed, shared meal, or short call).</li>
              </ul></div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">‚öñÔ∏è</div><div><div class="sum-title">Balance Work, Play, and Partnership</div><div class="sum-sub">Limits that protect both ambition and intimacy</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li><strong>His Company:</strong> Structured work hours with limits (no all-nighters).</li>
                <li><strong>His Gaming:</strong> Allowed, but only after couple time is honored.</li>
                <li><strong>Your Needs:</strong> Connection is prioritized, not treated as optional.</li>
              </ul></div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üß©</div><div><div class="sum-title">Responsibility for Impact</div><div class="sum-sub">Not "responsible for emotions," but responsible for choices + impact</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body">
                <p><strong>Reframe:</strong> He isn't responsible for emotions, but he is responsible for the impact of his choices.</p>
                <div class="mini-grid">
                  <div class="quote"><div class="who">You</div>"When you skip bed to work, the impact is I feel alone. I need you to take responsibility for that impact."</div>
                  <div class="quote"><div class="who">Him</div>"I hear that. I'll commit to coming to bed at least 4 nights a week."</div>
                </div>
              </div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üõ°Ô∏è</div><div><div class="sum-title">Defensiveness & Stubbornness</div><div class="sum-sub">Slow down defensiveness instead of shutting down</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li><strong>His Role:</strong> Pause before reacting. If defensive, say: "I'm feeling defensive right now. Let me take a breath before I respond."</li>
                <li><strong>Your Role:</strong> Frame requests as impact-based, not blame-based.</li>
                <li><strong>Joint Agreement:</strong> Defensiveness signals a need to slow down, not shut down.</li>
              </ul></div>
            </details>

            <details open><summary><div class="sum-left"><div class="sum-emoji">üîÑ</div><div><div class="sum-title">Interrupting The Loop</div><div class="sum-sub">Name the pattern before it becomes a fight</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li><strong>Your Role:</strong> Don't absorb blame or rush to stabilize. Name the pattern: "I think we're in the loop‚Äîlet's pause before we attach feelings to each other."</li>
                <li><strong>His Role:</strong> Acknowledge when projecting or rewriting the story. Practice saying: "This is my spike, not your fault."</li>
              </ul></div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üåü</div><div><div class="sum-title">Learning to Think Differently (Your Side)</div><div class="sum-sub">Shift from scarcity to recognition</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li>Shift from scarcity to recognition: actively notice when he shows care, even in small ways.</li>
                <li>Reframe effort: interpret his work and problem-solving as his language of value.</li>
                <li>Practice gratitude-in-the-moment: say, "That made me feel valued, thank you."</li>
                <li>Journal/track: write down 2‚Äì3 things each week that show his effort.</li>
              </ul></div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üöÄ</div><div><div class="sum-title">Steps He Can Take (His Side)</div><div class="sum-sub">Make care visible, intentional, and consistent</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li>Make effort visible: signal care through verbal reassurance, small acts of service, and intentional time.</li>
                <li>Ask directly: "What's one thing I can do this week that helps you feel valued?"</li>
                <li>Balance idealism with presence: ground entrepreneurial vision with tangible actions that show you matter now.</li>
                <li>Celebrate differences: acknowledge that realist optimism balances idealism.</li>
              </ul></div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üé®</div><div><div class="sum-title">Shared Fulfillment</div><div class="sum-sub">Connection + solo nourishment, without guilt</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li><strong>Couple Projects:</strong> Engage in creative activities together (trip, cooking, brainstorming, design eye).</li>
                <li><strong>Individual Nourishment:</strong> Each gets solo time for passions without guilt, because couple time is already protected.</li>
              </ul></div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üìÜ</div><div><div class="sum-title">Weekly Check-In Ritual</div><div class="sum-sub">30-minute review that builds trust over time</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body">
                <p><strong>30-Minute Review Prompts:</strong></p>
                <ul>
                  <li>What felt good this week?</li>
                  <li>What felt hurtful?</li>
                  <li>What's one adjustment we can make?</li>
                  <li>What effort did you notice from me?</li>
                  <li>What effort did I notice from you?</li>
                </ul>
              </div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üí¨</div><div><div class="sum-title">Communication Challenges</div><div class="sum-sub">Harshness + needs expression can block cooperation</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li><strong>Harshness & Needs Expression:</strong> Harshness and difficulty expressing needs in a positive way can create barriers for meeting those needs.</li>
                <li><strong>Goal:</strong> Foster more open, kind, and clear communication to better understand and support each other.</li>
              </ul></div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üîê</div><div><div class="sum-title">Trust & Fidelity</div><div class="sum-sub">Build trust through consistent care, not absolute guarantees</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li><strong>Promises about cheating:</strong> He cannot promise not to cheat because the future is unpredictable.</li>
                <li><strong>Your perspective:</strong> By the same logic, he cannot say he will cheat either.</li>
                <li><strong>Trust challenge:</strong> Inability to promise makes trust harder, especially given past experiences of being cheated on.</li>
                <li><strong>Path forward:</strong> Build trust through openness, consistent care, and visible commitment rather than absolute guarantees.</li>
              </ul></div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">‚ú®</div><div><div class="sum-title">Core Principle</div><div class="sum-sub">Recognition + visibility + balance = fulfillment</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body">
                <p><strong>Fulfillment comes when:</strong></p>
                <ul>
                  <li>You learn to see his efforts through recognition, not scarcity.</li>
                  <li>He makes his efforts visible and intentional.</li>
                  <li>Together you balance visionary drive with grounded optimism, creating a partnership where both feel valued and less hurt.</li>
                  <li>Both work on communication and trust to break negative loops and build emotional safety.</li>
                </ul>
              </div>
            </details>

            <details><summary><div class="sum-left"><div class="sum-emoji">üßæ</div><div><div class="sum-title">Summary of Concerns & Purpose</div><div class="sum-sub">Why this playbook exists + what it's trying to solve</div></div></div><div class="sum-right">open</div></summary>
              <div class="pb-body"><ul>
                <li><strong>Emotional Loop:</strong> A cycle where emotions escalate and create distance.</li>
                <li><strong>Communication Barriers:</strong> Harshness and difficulty expressing needs positively can block support.</li>
                <li><strong>Mutual Responsibility:</strong> Both take responsibility for impact; defensiveness means slow down.</li>
                <li><strong>Trust Challenges:</strong> Past betrayals make trust difficult; build trust through openness + consistent care.</li>
                <li><strong>Need for Visible Care:</strong> Care grows through visible commitment; recognition replaces scarcity.</li>
                <li><strong>Balancing Differences:</strong> Visionary drive + grounded optimism can complement.</li>
                <li><strong>Protecting Couple Time:</strong> Rituals + agreements keep connection protected.</li>
              </ul></div>
            </details>

            <div class="notice" style="margin-top:14px">
              <strong>Reminder:</strong> The goal is not blame. The goal is a shared framework: recognize patterns, make needs visible, build trust and care, and keep both people emotionally safe.
            </div>

            <div class="notice" style="margin-top:10px">
              <strong>Tip:</strong> This isn't about diagnosing anyone. It's about naming patterns so you can respond with clarity, fairness, and solid boundaries instead of getting swept into the same loop on repeat.
            </div>
          </div>

          <div id="tab-exercises" style="display:none">
            <div class="callout">
              <div class="row">
                <h2 style="margin:0">Joint Practice ‚Äî build new reflexes</h2>
                <div class="spacer"></div>
                <button class="btn small" id="btn-ex-speak">Speak</button>
                <button class="btn small" id="btn-ex-copy">Copy</button>
              </div>
              <div class="divider"></div>
              <div class="label">Today‚Äôs drill (2‚Äì10 minutes)</div>
              <select id="exercise-pick"></select>
              <div class="divider"></div>
              <div id="exercise-text" style="white-space:pre-wrap;line-height:1.45;font-size:.9rem"></div>
              <div class="notice">
                <strong>Goal:</strong> not ‚Äúwin the argument.‚Äù Build a repeatable way to feel safe, stay accurate, and stay connected.
              </div>
            </div>

            <div class="hr"></div>

            <div class="two">
              <div class="panel">
                <h3>Repair ritual (post-spike, same day)</h3>
                <ul>
                  <li><strong>Own</strong>: ‚ÄúHere‚Äôs what I did that had impact.‚Äù</li>
                  <li><strong>Validate</strong>: ‚ÄúYour feeling makes sense.‚Äù</li>
                  <li><strong>Clarify</strong>: ‚ÄúHere‚Äôs what I meant / what I didn‚Äôt mean.‚Äù</li>
                  <li><strong>Request</strong>: ‚ÄúNext time, can we do ____?‚Äù</li>
                  <li><strong>Close</strong>: one small act of care (touch, tea, walk, meme).</li>
                </ul>
              </div>
              <div class="panel">
                <h3>Conversation safety rules (for both)</h3>
                <ul>
                  <li>No insults, threats, or scorekeeping.</li>
                  <li>No mind-reading (‚Äúyou meant‚Ä¶‚Äù). Ask first.</li>
                  <li>‚ÄúI feel‚Äù must be a feeling, not an accusation.</li>
                  <li>One topic at a time. No history dump.</li>
                  <li>Cutoff is a pause, not abandonment ‚Äî return time required.</li>
                </ul>
              </div>
            </div>

            <div class="hr"></div>

            <div class="panel">
              <h3>Mini journal (together)</h3>
              <div class="two">
                <div>
                  <div class="label">What went well (today)</div>
                  <textarea id="ex-good" placeholder="2‚Äì3 things that helped connection, even small."></textarea>
                </div>
                <div>
                  <div class="label">One adjustment (tomorrow)</div>
                  <textarea id="ex-adjust" placeholder="One specific change we‚Äôll try next time."></textarea>
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn accent" id="btn-ex-save">Save Joint Notes</button>
                <button class="btn danger" id="btn-ex-clear">Clear</button>
                <div class="spacer"></div>
                <span class="mini">Saved locally.</span>
              </div>
            </div>
          </div>
</div>
          </div>

        </div>

        <div class="card" style="margin-top:12px">
          <h2>Loop Overview (tap a step)</h2>
          <div class="loop-strip" id="loop-strip"></div>
          <div class="two" style="margin-top:12px">
            <div class="panel">
              <h3 id="d-title">Step</h3>
              <p id="d-what"></p>
              <div class="chips">
                <span class="chip b" id="d-them"></span>
                <span class="chip a" id="d-you"></span>
              </div>
            </div>
            <div class="panel">
              <h3>Interrupt Moves</h3>
              <ul id="d-interrupt"></ul>
            </div>
          </div>
          <div class="notice" style="margin-top:10px">
            <strong>Riff:</strong> Emotion hits ‚Üí story hunts ‚Üí blame attaches ‚Üí repair demanded ‚Üí you regulate ‚Üí peace returns ‚Üí repeat.
            Upgrade: feelings first, stories checked second, reality stays intact, energy stays protected.
          </div>
        </div>
      </div>

      <div class="rightcol">
        <div class="card">
          <div class="row">
            <h2 style="margin:0">Media + Voice</h2>
            <div class="spacer"></div>
            <button class="btn small" id="btn-tts-stop">Stop Voice</button>
          </div>
          <div class="divider"></div>

          <div class="panel" style="margin-bottom:10px">
            <h3 style="margin:0 0 6px">Ambient Player (local storage playlist)</h3>
            <p class="mini">Add tracks now by URL. Later we can wire local files + your Swamp‚ÄëHop noir loop.</p>
            <div class="divider"></div>
            <div class="row">
              <button class="btn small" id="btn-add-track">Add Track</button>
              <button class="btn small danger" id="btn-clear-tracks">Clear</button>
              <div class="spacer"></div>
              <span class="mini">Saved locally.</span>
            </div>
            <audio id="audio" controls preload="none"></audio>
            <div class="row" style="margin-top:8px;gap:10px">
              <div style="flex:1">
                <div class="label">Playback rate</div>
                <input class="range" type="range" min="0.75" max="1.25" step="0.05" value="1" id="rate" />
              </div>
              <div style="min-width:160px">
                <div class="label">Loop</div>
                <select id="loopmode">
                  <option value="track">Track</option>
                  <option value="playlist">Playlist</option>
                  <option value="off">Off</option>
                </select>
              </div>
            </div>
            <div class="divider"></div>
            <div class="label">Playlist</div>
            <div id="playlist" class="log" style="max-height:210px"></div>
          </div>

          <div class="panel">
            <h3 style="margin:0 0 6px">ByteCast Voice (built‚Äëin TTS)</h3>
            <p class="mini">Uses your browser‚Äôs speech engine. Great for ‚Äúread the script while you breathe.‚Äù</p>
            <div class="divider"></div>
            <div class="row">
              <div style="flex:1;min-width:180px">
                <div class="label">Voice</div>
                <select id="voice"></select>
              </div>
              <div style="flex:1;min-width:180px">
                <div class="label">Style</div>
                <select id="tts-style">
                  <option value="calm">Calm</option>
                  <option value="coach">Coach</option>
                  <option value="neutral">Neutral</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn small accent" id="btn-tts-speak">Speak Text Below</button>
              <button class="btn small" id="btn-tts-paste-script">Paste Current Script</button>
            </div>
            <div class="divider"></div>
            <textarea id="tts-text" placeholder="Paste anything here‚Ä¶ playbook invite, cutoff script, your notes, etc."></textarea>
            <div class="notice">
              <strong>In‚Äëmoment pro move:</strong> Anchor reality ‚Üí name the pattern ‚Üí offer one next step ‚Üí exit on cutoff.
            </div>
          </div>

          <div class="notice" style="margin-top:10px">
            Everything persists in localStorage. Export JSON to move between devices. (Both partners can use one file on the same device.)
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const LOOP = [
  { id: 1, tag: "Body", title: "Emotion Spike", short:"A strong feeling shows up before the story is clear.",
    what:"A nervous-system spike can arrive fast (anxiety, shame, anger, fear, loneliness). A spike is real ‚Äî and it is not automatic proof of who caused it.",
    p1:"Feels impact, wants clarity, may push for reassurance.",
    p2:"Feels pressure, may feel blamed, may switch into defense/fixer mode.",
    interrupt:[
      "Slow the tempo (both).",
      "Name the feeling first; story second.",
      "Decide: care stays on; reality stays intact."
    ]},
  { id: 2, tag:"Search", title:"Meaning-Making", short:"The mind hunts for a reason to explain the feeling.",
    what:"When emotion is uncomfortable, the brain scans for a cause (tone, timing, details). This can produce assumptions faster than facts.",
    p1:"Tempted to interpret or mind-read.",
    p2:"Tempted to over-explain or shut down.",
    interrupt:[
      "Ask for one specific moment.",
      "Use facts: what happened / what was said.",
      "Label guesses as guesses."
    ]},
  { id: 3, tag:"Attach", title:"Pin It on the Other", short:"The feeling gets linked to the partner as the cause.",
    what:"A spike can turn into certainty: 'I feel this because you did X.' Sometimes true; sometimes a shortcut that skips verification.",
    p1:"May escalate certainty, demand repair.",
    p2:"May feel accused, counter-argue, or cave to restore peace.",
    interrupt:[
      "Separate feeling from conclusion.",
      "Ban global frames (always/never).",
      "Care without forced confession."
    ]},
  { id: 4, tag:"Drift", title:"Narrative Drift", short:"Details start shifting to match the emotion‚Äôs conclusion.",
    what:"When the goal becomes emotional coherence, accuracy can slip. This is where looping happens and trust erodes.",
    p1:"May double down, stack examples, intensify language.",
    p2:"May feel miscast, get sharper, or try to 'fix' perception.",
    interrupt:[
      "Re-anchor: timestamps, exact words, single claim.",
      "Pause if insults/mind-reading begins.",
      "Return to one request."
    ]},
  { id: 5, tag:"Repair", title:"Repair Demand", short:"Reassurance or apology is demanded right now, on one person‚Äôs terms.",
    what:"Repair is healthy; pressure-based repair is not. The difference: shared goals vs forcing someone to carry the whole emotional load.",
    p1:"Wants proof of care, safety, commitment.",
    p2:"Wants fairness, accuracy, and room to be human.",
    interrupt:[
      "Offer support + next step without rewriting truth.",
      "Make requests specific (one action, one time).",
      "If it becomes coercive, use the cutoff."
    ]},
  { id: 6, tag:"Regulate", title:"Over-Functioning", short:"One partner becomes the regulator to restore calm.",
    what:"If calm returns only when one person fixes, apologizes, or performs care, the loop gets reinforced.",
    p1:"Gets soothed temporarily, but no new skill is built.",
    p2:"Gets drained, resentful, and vigilant.",
    interrupt:[
      "Scale effort to responsibility.",
      "Switch to joint tools (translator, repair ritual).",
      "Name the pattern without blame."
    ]},
  { id: 7, tag:"Reset", title:"Temporary Peace", short:"Harmony returns ‚Äî then the next spike restarts the cycle.",
    what:"Without practice + agreements, the nervous system learns 'spike ‚Üí pressure ‚Üí soothing' and repeats it.",
    p1:"Feels relief, but fears it will happen again.",
    p2:"Feels relief, but fears it will happen again.",
    interrupt:[
      "Do a 5-minute drill when calm.",
      "Schedule protected time (connection builds safety).",
      "Commit to cutoff + return time every time."
    ]}
];

const ANCHORS = [
  "Thank you for telling me ‚Äî your feeling matters to me.",
  "I can validate the feeling AND still verify the facts. Both are allowed.",
  "Let‚Äôs slow down: what are you feeling, and what do you need right now?",
  "I‚Äôm not dismissing you ‚Äî I‚Äôm making sure we stay accurate and fair to both of us.",
  "If a sentence starts with ‚ÄòI feel‚Äô but is actually a conclusion, we‚Äôll translate it into: feeling + observation + request.",
  "We can pause without abandoning: cutoff = protection + return time."
];

function buildScript(view, stepId, cutoffMin, running){
  const s = LOOP.find(x=>x.id===stepId) || LOOP[0];
  const cutoffLine = cutoffMin>0
    ? `\n\nCutoff: We‚Äôve got ${cutoffMin} minutes to stay constructive. If we start looping or getting sharp, we pause and set a return time.`
    : "";

  // Partner 1 language leans "B-advocacy": feelings + needs made visible, asks become clean.
  const P1 = [
`Thank you for telling me ‚Äî I‚Äôm feeling something real.

I want you to understand me, and I want to stay fair to you.
Can we do this clean?
‚Ä¢ Feeling (one word)
‚Ä¢ Observation (one specific moment)
‚Ä¢ Need (what I‚Äôm needing underneath)
‚Ä¢ Request (one next step)

If I start accusing or mind-reading, please help me translate it back into a feeling + request.`,
`I‚Äôm looking for reassurance and connection ‚Äî not control.

Here‚Äôs my clean ask:
When __ happened, I felt __.
I need __.
Can you __ (one specific action/time)?`,
`I‚Äôm noticing my intensity rising.

If my tone gets sharp or I start stacking examples, I‚Äôm going to pause, breathe, and restate the need.
I want closeness ‚Äî not a win.`
  ];

  // Partner 2 language protects boundaries while still advocating for Partner 1's feelings and needs.
  const P2 = [
`I hear you. Your feeling matters to me.

I can validate your emotion without agreeing to every conclusion.
Let‚Äôs slow down and get clarity:
‚Ä¢ What are you feeling?
‚Ä¢ What do you need right now?
‚Ä¢ What‚Äôs the one moment we‚Äôre talking about?

I‚Äôm here ‚Äî and I‚Äôm staying accurate so we can actually solve it.`,
`I care about you, and I‚Äôm not dismissing you.

I will respond to specifics ‚Äî not broad labels like ‚Äúalways/never.‚Äù
Give me one moment, and I‚Äôll meet it honestly, then we‚Äôll choose one repair step.`,
`I want this to feel safe for both of us.

If we hit insults, threats, pressure-repair, or reality-rewrite, I‚Äôm pausing ‚Äî with a return time.
That protects us and keeps love on the table.`
  ];

  // Together mode: explicitly advocates for feelings + needs while setting shared limits.
  const T = [
`Team mode.

We‚Äôre on the same side. Big feelings are welcome here ‚Äî and we keep it fair.
Step 1: name the feeling (no accusations).
Step 2: name the need (reassurance, respect, closeness, clarity, rest).
Step 3: confirm one fact (one moment).
Step 4: make one request (one next step).
Step 5: pick one repair action (small, real, today).`,
`We can hold two truths:
1) your feelings matter and deserve care
2) our story needs to be accurate for trust

Let‚Äôs slow down, pick one moment, and aim for one next step ‚Äî not a courtroom.`,
`If we‚Äôre getting sharp, we pause. Not abandonment ‚Äî protection.
Return time: __:__.
When we come back: feeling ‚Üí need ‚Üí fact ‚Üí request ‚Üí repair.`
  ];

  const base = view==="P1" ? P1 : (view==="P2" ? P2 : T);
  const opener = base[Math.min(stepId-1, base.length-1)];
  const stepHint = `\n\nRight now we‚Äôre at Step ${s.id} ‚Äî ${s.title}.`;
  const micro = `\nMicro-move: ${s.interrupt[0]}`;
  const session = running ? "\n\nLane: care + clarity + limits." : "";
  return `${opener}${stepHint}${micro}${cutoffLine}${session}`;
}


function defaultInvite(){
return `Relationship Playbook for Fulfillment and Care to help us better understand and navigate some recurring loops we get caught in. It‚Äôs a shared framework for communication, trust, and responsibility ‚Äî so we can both feel valued, supported, and emotionally safe.

This playbook isn‚Äôt about blame. It‚Äôs about protecting feelings, protecting truth, and making needs visible ‚Äî together. It‚Äôs about:
‚Ä¢ recognizing patterns early
‚Ä¢ making needs visible
‚Ä¢ validating feelings without distorting reality
‚Ä¢ building trust through consistent care + clean agreements

I‚Äôd love for us to review it together when we‚Äôre calm and pick 1‚Äì2 small practices to try this week.

Thank you for being willing to explore.`;
}
function defaultInvite(){
return `Relationship Playbook for Fulfillment and Care to help us better understand and navigate some of the challenges we‚Äôve been facing. It‚Äôs a clear, shared framework that covers the emotional loops we get caught in, communication struggles, trust issues, and how we can both take responsibility for creating a stronger, more fulfilling partnership.

This playbook isn‚Äôt about blame‚Äîit‚Äôs about recognizing patterns, making our needs visible, and building trust and care in ways that honor both of us. It also addresses how harshness and difficulty expressing needs in a positive way can make it hard to meet those needs, and the trust challenges that come from past experiences.

I believe that by working through this together‚Äîbalancing visionary drive with grounded optimism‚Äîwe can break negative loops, communicate more openly, and create a relationship where we both feel valued, supported, and emotionally safe.

I‚Äôd love for us to review this together and talk about how we can put it into practice.

Thank you for being willing to explore.`;
}
function defaultCutoff(){
return `I care about you, and I care about us.

I‚Äôm noticing we‚Äôre looping / getting sharp, and I don‚Äôt want us to say things we can‚Äôt take back.

I‚Äôm going to pause this conversation now. Let‚Äôs take 20‚Äì30 minutes, reset, and come back at __:__.

When we return: we‚Äôll name the feeling, confirm one fact, and make one clear request.

This isn‚Äôt abandonment ‚Äî it‚Äôs protection.`;
}

const K = {
  profile: "lb_profile",
  step: "lb_step",
  cutoff: "lb_cutoff",
  running: "lb_running",
  start: "lb_start_ts",
  invite: "lb_invite",
  cutoffScript: "lb_cutoff_script",
  weekly: "lb_weekly_notes",
  ttsText: "lb_tts_text",
  ttsStyle: "lb_tts_style",
  voice: "lb_voice_uri",
  tracks: "lb_tracks",
  rate: "lb_rate",
  loopmode: "lb_loopmode",
  logP1: "lb_log_P1",
  logP2: "lb_log_P2",
  joint: "lb_joint_notes",
};

function safeSet(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
function safeGet(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function nowISO(){ return new Date().toISOString(); }
function fmtTime(iso){
  try{ return new Date(iso).toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"}); }
  catch(e){ return "‚Äî"; }
}
function escapeHtml(s){
  return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

const tabs = document.querySelectorAll(".tab");
const tabMoment = document.getElementById("tab-moment");
const tabJournal = document.getElementById("tab-journal");
const tabPlaybook = document.getElementById("tab-playbook");

const profileSel = document.getElementById("profile");
const stepSel = document.getElementById("step-select");
const cutoffSel = document.getElementById("cutoff");

const scriptEl = document.getElementById("script-text");
const anchorList = document.getElementById("anchor-list");

const btnStart = document.getElementById("btn-start");
const btnStop = document.getElementById("btn-stop");
const sessionLabel = document.getElementById("session-label");
const cutLabel = document.getElementById("cut-label");
const cutDot = document.getElementById("cut-dot");

const factsEl = document.getElementById("log-facts");
const needEl = document.getElementById("log-need");
const btnSave = document.getElementById("btn-save");
const btnClearFields = document.getElementById("btn-clear-fields");

const searchEl = document.getElementById("search");
const filterStep = document.getElementById("filter-step");
const logList = document.getElementById("log-list");
const btnClearLog = document.getElementById("btn-clear-log");

const kCount = document.getElementById("k-count");
const kLast = document.getElementById("k-last");
const kMode = document.getElementById("k-mode");

const pbIntro = document.getElementById("pb-intro");
const pbWeekly = document.getElementById("pb-weekly");
const cutoffScriptEl = document.getElementById("cutoff-script");

const btnExport = document.getElementById("btn-export");
const btnExport2 = document.getElementById("btn-export2");
const btnReset = document.getElementById("btn-reset");

const btnSpeak = document.getElementById("btn-speak");
const btnCopy = document.getElementById("btn-copy");

const fvInput = document.getElementById("fv-input");
const fvOutput = document.getElementById("fv-output");
const btnFV = document.getElementById("btn-fv");
const btnFVS = document.getElementById("btn-fv-speak");

const btnInviteSpeak = document.getElementById("btn-invite-speak");
const btnInviteCopy = document.getElementById("btn-invite-copy");
const btnResetIntro = document.getElementById("btn-reset-intro");
const btnClearIntro = document.getElementById("btn-clear-intro");
const btnCutSpeak = document.getElementById("btn-cut-speak");
const btnCutCopy = document.getElementById("btn-cut-copy");

const btnTTSStop = document.getElementById("btn-tts-stop");
const voiceSel = document.getElementById("voice");
const ttsStyleSel = document.getElementById("tts-style");
const btnTTSSpeak = document.getElementById("btn-tts-speak");
const btnTTSPaste = document.getElementById("btn-tts-paste-script");
const ttsText = document.getElementById("tts-text");

const audio = document.getElementById("audio");
const playlistEl = document.getElementById("playlist");
const btnAddTrack = document.getElementById("btn-add-track");
const btnClearTracks = document.getElementById("btn-clear-tracks");
const rateEl = document.getElementById("rate");
const loopModeEl = document.getElementById("loopmode");

const loopStrip = document.getElementById("loop-strip");
const dTitle = document.getElementById("d-title");
const dWhat = document.getElementById("d-what");
const dThem = document.getElementById("d-them");
const dYou = document.getElementById("d-you");
const dInterrupt = document.getElementById("d-interrupt");

let activeStep = 1;

function renderLoopStrip(){
  loopStrip.innerHTML = "";
  LOOP.forEach((s,idx)=>{
    const el = document.createElement("div");
    el.className = "step";
    el.dataset.id = s.id;
    el.innerHTML = `<div class="step-tag">${s.tag}</div>
      <div class="step-title">${s.id}. ${s.title}</div>
      <div class="step-sub">${s.short}</div>`;
    el.addEventListener("click", ()=>setStep(s.id,true));
    loopStrip.appendChild(el);
    if(idx<LOOP.length-1){
      const a = document.createElement("div");
      a.className = "arrow";
      a.textContent = "‚ûú";
      loopStrip.appendChild(a);
    }
  });
}

function setStep(id, syncSelect=false){
  activeStep = id;
  document.querySelectorAll(".step").forEach(x=>x.classList.remove("active"));
  const c = document.querySelector(`.step[data-id="${id}"]`);
  if(c) c.classList.add("active");

  const s = LOOP.find(x=>x.id===id) || LOOP[0];
  dTitle.textContent = `Step ${s.id} ‚Äî ${s.title}`;
  dWhat.textContent = s.what;
  dThem.textContent = `Partner 1: ${s.p1}`;
  dYou.textContent = `Partner 2: ${s.p2}`;
  dInterrupt.innerHTML = "";
  s.interrupt.forEach(i=>{
    const li = document.createElement("li");
    li.textContent = i;
    dInterrupt.appendChild(li);
  });

  if(syncSelect){
    stepSel.value = String(id);
    safeSet(K.step, id);
  }
  refreshScript();
}


const NEEDS = ["reassurance","closeness","respect","clarity","repair","time","rest","space","honesty","warmth","attention","consistency","teamwork","patience"];
function renderNeeds(){
  const wrap = document.getElementById("needs-chips");
  if(!wrap) return;
  wrap.innerHTML = "";
  NEEDS.forEach(n=>{
    const s = document.createElement("span");
    s.className = "chip b";
    s.textContent = n;
    s.style.cursor = "pointer";
    s.title = "Click to add to Feeling + Need";
    s.addEventListener("click", ()=>{
      const cur = (needEl?.value || "").trim();
      const add = `Need: ${n}`;
      needEl.value = cur ? (cur + (cur.endsWith("\n")?"":"\n") + add) : add;
      safeSet("lb_last_need", needEl.value);
    });
    wrap.appendChild(s);
  });
}

function renderAnchors(){
  anchorList.innerHTML="";
  ANCHORS.forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    anchorList.appendChild(li);
  });
}



const tabExercises = document.getElementById("tab-exercises");
function showTab(which){
  tabMoment.style.display = which==="moment" ? "" : "none";
  tabJournal.style.display = which==="journal" ? "" : "none";
  tabPlaybook.style.display = which==="playbook" ? "" : "none";
  if(tabExercises) tabExercises.style.display = which==="exercises" ? "" : "none";
  tabs.forEach(t=>t.classList.toggle("active", t.dataset.tab===which));
  if(which==="journal") renderLog();
}
tabs.forEach(t=>t.addEventListener("click", ()=>showTab(t.dataset.tab)));

let timer = null;
let running = false;

function updateSessionUI(){
  if(!running){
    sessionLabel.textContent = "Session: ready";
    cutLabel.textContent = "Cutoff: not set";
    cutDot.style.display = "none";
    return;
  }
  const start = safeGet(K.start, null);
  const cut = Number(cutoffSel.value || 0);
  const elapsed = start ? Math.max(0, Math.floor((Date.now() - start)/1000)) : 0;

  sessionLabel.textContent = `Session: ${Math.floor(elapsed/60)}m ${elapsed%60}s`;
  if(cut>0){
    const left = Math.max(0, cut*60 - elapsed);
    cutLabel.textContent = `Cutoff: ${Math.floor(left/60)}m ${left%60}s left`;
    cutDot.style.display = left<=60 ? "" : "none";
  }else{
    cutLabel.textContent = "Cutoff: none";
    cutDot.style.display = "none";
  }
}

function startSession(){
  running = true;
  safeSet(K.running, true);
  safeSet(K.start, Date.now());
  updateSessionUI();
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    updateSessionUI();
    const cut = Number(cutoffSel.value || 0);
    const start = safeGet(K.start, null);
    if(running && cut>0 && start){
      const elapsed = Math.floor((Date.now() - start)/1000);
      if(elapsed >= cut*60){
        cutDot.style.display = "";
        cutLabel.textContent = "Cutoff: reached (pause + return time)";
        if((ttsText.value||"").trim().length===0){
          ttsText.value = cutoffScriptEl.value || defaultCutoff();
          safeSet(K.ttsText, ttsText.value);
        }
      }
    }
  }, 500);
  refreshScript();
}

function stopSession(){
  running = false;
  safeSet(K.running, false);
  safeSet(K.start, null);
  if(timer) clearInterval(timer);
  timer = null;
  updateSessionUI();
  refreshScript();
}

btnStart.addEventListener("click", startSession);
btnStop.addEventListener("click", stopSession);

function refreshScript(){
  const profile = profileSel.value;
  const cut = Number(cutoffSel.value || 0);
  const txt = buildScript(profile, activeStep, cut, running);
  scriptEl.textContent = txt;
}

function copyText(txt){
  navigator.clipboard?.writeText(txt).catch(()=>{});
}
btnCopy.addEventListener("click", ()=>copyText(scriptEl.textContent));
btnInviteCopy.addEventListener("click", ()=>copyText(pbIntro.value));
btnCutCopy.addEventListener("click", ()=>copyText(cutoffScriptEl.value));

const FEELINGS = ["sad","hurt","scared","angry","frustrated","lonely","anxious","overwhelmed","disrespected","dismissed","unseen","unimportant","jealous","ashamed","guilty","confused","tired","resentful","unsafe","tense"];
function translateFeelVsThink(s){
  const raw = (s||"").trim();
  if(!raw) return "";
  const lower = raw.toLowerCase();
  const isThoughtMask = lower.includes("i feel") && (lower.includes("you ") || lower.includes("that ") || lower.includes("like ") || lower.includes("never") || lower.includes("always"));
  const feelingWord = FEELINGS.find(f=>lower.includes("i feel "+f) || lower.includes("feel "+f)) || null;
  const feeling = feelingWord ? feelingWord : (isThoughtMask ? "hurt / anxious (pick one)" : "___");
  const observation = "Observation: (one concrete moment) ______";
  const request = "Request: (one specific next step) ______";
  const note = isThoughtMask
    ? "Note: that sentence is an interpretation. We keep the feeling (valid) and rewrite the interpretation into an observation + request (fair)."
    : "Note: keep it short, concrete, and non-accusatory.";
  return `Feeling: ${feeling}\n${observation}\nMeaning (optional, labeled as guess): ______\n${request}\n\n${note}`;
}
btnFV.addEventListener("click", ()=>{ fvOutput.value = translateFeelVsThink(fvInput.value); });

function getLogKey(){ return profileSel.value==="P2" ? K.logP2 : K.logP1; }
function getLog(){ return safeGet(getLogKey(), []); }
function setLog(arr){ safeSet(getLogKey(), arr); updateKPIs(); }

function saveEntry(){
  const facts = (factsEl.value||"").trim();
  const need = (needEl.value||"").trim();
  if(!facts && !need) return;
  const entry = { id: Math.random().toString(16).slice(2), ts: nowISO(), profile: profileSel.value, stepId: activeStep, facts, need };
  const log = getLog();
  log.unshift(entry);
  setLog(log);
  factsEl.value = "";
  needEl.value = "";
  renderLog();
}
btnSave.addEventListener("click", saveEntry);
btnClearFields.addEventListener("click", ()=>{factsEl.value="";needEl.value="";});
[factsEl, needEl].forEach(el=>{
  el.addEventListener("keydown", (e)=>{ if(e.ctrlKey && e.key==="Enter"){ e.preventDefault(); saveEntry(); } });
});

function updateKPIs(){
  const log = getLog();
  kCount.textContent = String(log.length);
  kLast.textContent = log[0]?.ts ? fmtTime(log[0].ts) : "‚Äî";
  kMode.textContent = profileSel.value;
}

function renderLog(){
  const q = (searchEl.value||"").toLowerCase().trim();
  const f = filterStep.value || "all";
  const log = getLog();
  const filtered = log.filter(e=>{
    const matchesQ = !q || (e.facts||"").toLowerCase().includes(q) || (e.need||"").toLowerCase().includes(q);
    const matchesF = (f==="all") || (String(e.stepId)===String(f));
    return matchesQ && matchesF;
  });
  logList.innerHTML = "";
  if(filtered.length===0){
    const empty = document.createElement("div");
    empty.className = "entry";
    empty.innerHTML = `<div class="meta">No entries yet. Use <code>In‚ÄëMoment</code> ‚Üí <code>Save Entry</code>.</div>`;
    logList.appendChild(empty);
  }else{
    filtered.forEach(e=>{
      const s = LOOP.find(x=>x.id===e.stepId);
      const wrap = document.createElement("div");
      wrap.className = "entry";
      wrap.innerHTML = `
        <div class="meta">
          <code>${e.profile}</code>
          <code>Step ${e.stepId}</code>
          <span>${fmtTime(e.ts)}</span>
          <span class="spacer"></span>
          <button class="btn small danger" data-del="${e.id}">Delete</button>
        </div>
        <div class="txt"><strong>${s ? s.title : "Step"}</strong>\n\nFacts:\n${escapeHtml(e.facts)}\n\nFeeling/Need:\n${escapeHtml(e.need)}</div>
      `;
      wrap.querySelector("[data-del]")?.addEventListener("click", ()=>{
        const id = e.id;
        const next = getLog().filter(x=>x.id!==id);
        setLog(next);
        renderLog();
      });
      logList.appendChild(wrap);
    });
  }
  updateKPIs();
}
searchEl.addEventListener("input", renderLog);
filterStep.addEventListener("change", renderLog);
btnClearLog.addEventListener("click", ()=>{
  safeSet(getLogKey(), []);
  renderLog();
});

function exportAll(){
  const payload = {
    exportedAt: nowISO(),
    profile: profileSel.value,
    settings: { step: activeStep, cutoff: Number(cutoffSel.value||0), running: running },
    playbook: { invite: pbIntro.value, cutoffScript: cutoffScriptEl.value, weeklyNotes: pbWeekly.value },
    media: { tracks: safeGet(K.tracks, []), rate: Number(rateEl.value||1), loopmode: loopModeEl.value },
    log: getLog()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `loop_breaker_v3_${profileSel.value}_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}
btnExport.addEventListener("click", exportAll);
btnExport2.addEventListener("click", exportAll);

btnReset.addEventListener("click", ()=>{
  if(!confirm("Reset all local data for this workbook (settings, logs, playbook, media)?")) return;
  Object.values(K).forEach(k=>{ try{ localStorage.removeItem(k); }catch(e){} });
  location.reload();
});

profileSel.addEventListener("change", ()=>{
  safeSet(K.profile, profileSel.value);
  renderLog();
  refreshScript();
});
stepSel.addEventListener("change", ()=>{ setStep(Number(stepSel.value||1), true); });
cutoffSel.addEventListener("change", ()=>{ safeSet(K.cutoff, Number(cutoffSel.value||0)); refreshScript(); });

pbIntro.addEventListener("input", ()=>safeSet(K.invite, pbIntro.value));
pbWeekly.addEventListener("input", ()=>safeSet(K.weekly, pbWeekly.value));
cutoffScriptEl.addEventListener("input", ()=>safeSet(K.cutoffScript, cutoffScriptEl.value));

btnResetIntro.addEventListener("click", ()=>{ pbIntro.value = defaultInvite(); safeSet(K.invite, pbIntro.value); });
btnClearIntro.addEventListener("click", ()=>{ pbIntro.value = ""; safeSet(K.invite, ""); });

/* TTS */
let voices = [];
function loadVoices(){
  if(!("speechSynthesis" in window)) return;
  voices = window.speechSynthesis.getVoices() || [];
  voiceSel.innerHTML = "";
  voices.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSel.appendChild(opt);
  });
  const saved = safeGet(K.voice, "");
  if(saved && voices.find(v=>v.voiceURI===saved)) voiceSel.value = saved;
  else{
    const pref = voices.find(v=>/en-US/i.test(v.lang) && /Google|Samantha|Alex|Zira|Natural|Neural/i.test(v.name))
      || voices.find(v=>/en-US/i.test(v.lang)) || voices[0];
    if(pref) voiceSel.value = pref.voiceURI;
  }
}
window.speechSynthesis?.addEventListener?.("voiceschanged", loadVoices);
setTimeout(loadVoices, 250);

function stopSpeech(){ try{ window.speechSynthesis.cancel(); }catch(e){} }
btnTTSStop.addEventListener("click", stopSpeech);

function speak(text){
  if(!("speechSynthesis" in window)) return;
  stopSpeech();
  const t = (text||"").trim();
  if(!t) return;
  const u = new SpeechSynthesisUtterance(t);
  const style = ttsStyleSel.value || "calm";
  if(style==="calm"){ u.rate=0.96; u.pitch=1.0; u.volume=1.0; }
  if(style==="coach"){ u.rate=1.03; u.pitch=1.05; u.volume=1.0; }
  if(style==="neutral"){ u.rate=1.0; u.pitch=1.0; u.volume=1.0; }
  const chosen = voices.find(v=>v.voiceURI===voiceSel.value);
  if(chosen) u.voice = chosen;
  window.speechSynthesis.speak(u);
}
btnSpeak.addEventListener("click", ()=>speak(scriptEl.textContent));
btnInviteSpeak.addEventListener("click", ()=>speak(pbIntro.value));
btnCutSpeak.addEventListener("click", ()=>speak(cutoffScriptEl.value));
btnFVS.addEventListener("click", ()=>speak(fvOutput.value || ""));
btnTTSSpeak.addEventListener("click", ()=>speak(ttsText.value));
btnTTSPaste.addEventListener("click", ()=>{ ttsText.value = scriptEl.textContent; safeSet(K.ttsText, ttsText.value); });
voiceSel.addEventListener("change", ()=>safeSet(K.voice, voiceSel.value));
ttsStyleSel.addEventListener("change", ()=>safeSet(K.ttsStyle, ttsStyleSel.value));
ttsText.addEventListener("input", ()=>safeSet(K.ttsText, ttsText.value));

/* Media playlist */
function getTracks(){ return safeGet(K.tracks, []); }
function setTracks(t){ safeSet(K.tracks, t); renderPlaylist(); }
let currentIndex = 0;

function renderPlaylist(){
  const tracks = getTracks();
  playlistEl.innerHTML = "";
  if(tracks.length===0){
    const e = document.createElement("div");
    e.className = "entry";
    e.innerHTML = `<div class="meta">No tracks yet. Click <code>Add Track</code>.</div>`;
    playlistEl.appendChild(e);
    audio.removeAttribute("src");
    return;
  }
  tracks.forEach((tr, idx)=>{
    const e = document.createElement("div");
    e.className = "entry";
    const active = idx===currentIndex;
    e.innerHTML = `
      <div class="meta">
        <code>${active ? "‚ñ∂" : " "}</code>
        <span>${escapeHtml(tr.name || ("Track "+(idx+1)))}</span>
        <span class="spacer"></span>
        <button class="btn small" data-play="${idx}">Play</button>
        <button class="btn small danger" data-del="${idx}">Del</button>
      </div>
      <div class="mini">${escapeHtml(tr.url || "")}</div>
    `;
    e.querySelector("[data-play]")?.addEventListener("click", ()=>playIndex(idx,true));
    e.querySelector("[data-del]")?.addEventListener("click", ()=>{
      const t = getTracks();
      t.splice(idx,1);
      if(currentIndex>=t.length) currentIndex = Math.max(0, t.length-1);
      setTracks(t);
      if(t.length>0) playIndex(currentIndex,false);
    });
    playlistEl.appendChild(e);
  });
}
function playIndex(idx, autoplay){
  const tracks = getTracks();
  if(!tracks[idx]) return;
  currentIndex = idx;
  audio.src = tracks[idx].url;
  audio.playbackRate = Number(rateEl.value||1);
  audio.loop = (loopModeEl.value==="track");
  renderPlaylist();
  if(autoplay) audio.play().catch(()=>{});
}
audio.addEventListener("ended", ()=>{
  const mode = loopModeEl.value;
  const tracks = getTracks();
  if(mode==="track") return;
  if(mode==="playlist" && tracks.length>0){
    playIndex((currentIndex+1)%tracks.length, true);
  }
});
btnAddTrack.addEventListener("click", ()=>{
  const url = prompt("Paste an audio URL (mp3/ogg/wav):");
  if(!url) return;
  const name = prompt("Track name (optional):") || url.split("/").slice(-1)[0] || "Track";
  const t = getTracks();
  t.push({name, url});
  setTracks(t);
  if(t.length===1) playIndex(0,false);
});
btnClearTracks.addEventListener("click", ()=>{ if(confirm("Clear playlist?")) setTracks([]); });
rateEl.addEventListener("input", ()=>{ safeSet(K.rate, Number(rateEl.value||1)); audio.playbackRate = Number(rateEl.value||1); });
loopModeEl.addEventListener("change", ()=>{ safeSet(K.loopmode, loopModeEl.value); audio.loop = (loopModeEl.value==="track"); });

function initSelects(){
  stepSel.innerHTML = "";
  LOOP.forEach(s=>{
    const o = document.createElement("option");
    o.value = String(s.id);
    o.textContent = `Step ${s.id} ‚Äî ${s.title}`;
    stepSel.appendChild(o);
    const f = document.createElement("option");
    f.value = String(s.id);
    f.textContent = `Step ${s.id} ‚Äî ${s.title}`;
    filterStep.appendChild(f);
  });
}


/* Exercises (joint drills) */
const EX = [
  {
    id:"two-minute-reset",
    name:"2-minute Reset (in the moment)",
    text:`1) Both take 3 slow breaths.\n2) Each says ONE feeling word.\n3) Each says ONE fact (no meaning).\n4) Each makes ONE request (specific next step).\n\nClose with: ‚ÄúSame team. One step.‚Äù`
  },
  {
    id:"feelings-vs-thoughts",
    name:"Feelings vs Thoughts (clean language)",
    text:`Practice converting:\n‚ÄúI feel you don‚Äôt care.‚Äù ‚Üí ‚ÄúI feel hurt/lonely. When __ happened, I needed __. Can we __?‚Äù\n\nRule: feelings are emotions; thoughts are interpretations. We label thoughts as guesses.`
  },
  {
    id:"reflect-and-verify",
    name:"Reflect + Verify (no mind-reading)",
    text:`Partner A speaks 30‚Äì60 seconds.\nPartner B reflects: ‚ÄúWhat I heard is __. Did I get it?‚Äù\nThen verify ONE fact: ‚ÄúThe moment was __ at __. Correct?‚Äù\nThen request ONE next step.`
  },
  {
    id:"repair-3x3",
    name:"Repair 3√ó3 (after a spike)",
    text:`Each partner answers 3 questions in 3 minutes:\n1) What impact did my behavior have?\n2) What do I wish I had done instead?\n3) What can I do in the next 24h to rebuild trust?\n\nPick ONE action each and do it today.`
  },
  {
    id:"protected-time",
    name:"Protected Time Planning (weekly)",
    text:`Pick 2‚Äì3 connection blocks.\nPick 1 solo block each.\nPick 1 weekly check-in time.\n\nAgreement: play/work happens after connection blocks are honored.`
  }
];

const exPick = document.getElementById("exercise-pick");
const exText = document.getElementById("exercise-text");
const exGood = document.getElementById("ex-good");
const exAdjust = document.getElementById("ex-adjust");
const btnExSpeak = document.getElementById("btn-ex-speak");
const btnExCopy = document.getElementById("btn-ex-copy");
const btnExSave = document.getElementById("btn-ex-save");
const btnExClear = document.getElementById("btn-ex-clear");

function renderExercises(){
  if(!exPick) return;
  exPick.innerHTML = "";
  EX.forEach(x=>{
    const o=document.createElement("option");
    o.value=x.id; o.textContent=x.name;
    exPick.appendChild(o);
  });
  const savedId = safeGet("lb_ex_pick","two-minute-reset");
  exPick.value = EX.find(x=>x.id===savedId) ? savedId : EX[0].id;
  showExercise(exPick.value);
}

function showExercise(id){
  const x = EX.find(e=>e.id===id) || EX[0];
  safeSet("lb_ex_pick", x.id);
  if(exText) exText.textContent = x.text;
}

exPick?.addEventListener("change", ()=>showExercise(exPick.value));
btnExCopy?.addEventListener("click", ()=>copyText(exText?.textContent || ""));
btnExSpeak?.addEventListener("click", ()=>speak(exText?.textContent || ""));

function loadJoint(){
  const j = safeGet(K.joint, {good:"", adjust:""});
  if(exGood) exGood.value = j.good || "";
  if(exAdjust) exAdjust.value = j.adjust || "";
}
function saveJoint(){
  safeSet(K.joint, {good: (exGood?.value||""), adjust:(exAdjust?.value||"")});
}
btnExSave?.addEventListener("click", saveJoint);
btnExClear?.addEventListener("click", ()=>{
  if(exGood) exGood.value="";
  if(exAdjust) exAdjust.value="";
  saveJoint();
});
exGood?.addEventListener("input", saveJoint);
exAdjust?.addEventListener("input", saveJoint);

function init(){
  initSelects();
  renderLoopStrip();
  renderAnchors();
  renderNeeds();
  renderExercises();
  loadJoint();

  profileSel.value = safeGet(K.profile, "P1");
  activeStep = safeGet(K.step, 1);
  stepSel.value = String(activeStep);
  cutoffSel.value = String(safeGet(K.cutoff, 0));

  ttsStyleSel.value = safeGet(K.ttsStyle, "calm");
  ttsText.value = safeGet(K.ttsText, "");
  pbIntro.value = safeGet(K.invite, defaultInvite());
  cutoffScriptEl.value = safeGet(K.cutoffScript, defaultCutoff());
  pbWeekly.value = safeGet(K.weekly, "");

  rateEl.value = String(safeGet(K.rate, 1));
  loopModeEl.value = safeGet(K.loopmode, "track");
  audio.playbackRate = Number(rateEl.value||1);
  audio.loop = (loopModeEl.value==="track");

  running = safeGet(K.running, false);
  if(running){
    const st = safeGet(K.start, null);
    if(!st) safeSet(K.start, Date.now());
    startSession();
  }else{
    updateSessionUI();
  }

  setStep(activeStep, false);
  renderPlaylist();
  updateKPIs();
  renderLog();
  refreshScript();
}
init();

document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") stopSpeech(); });
</script>
</body>
</html>
